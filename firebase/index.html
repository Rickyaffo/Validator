<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n-key="app_title">VALIDATR™ - Dashboard Completa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserSessionPersistence, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, query, getDocs, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Configurazione Firebase del tuo progetto (Sostituisci con i tuoi valori reali)
        const firebaseConfig = {
            apiKey: "AIzaSyDlGp9jxE1YubvFm6MDqSMT9M9G_5iu1f4",
            authDomain: "validatr-mvp.firebaseapp.com",
            projectId: "validatr-mvp",
            storageBucket: "validatr-mvp.firebasestorage.app",
            messagingSenderId: "967024558151",
            appId: "1:967024558151:web:55146fdedd24314cc6f162",
            measurementId: "G-JEE15JVL0N"
        };

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);


        // Espongo le istanze globalmente per lo script principale
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseStorage = storage;
        window.setPersistence = setPersistence;
        window.browserSessionPersistence = browserSessionPersistence;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.collection = collection;
        window.query = query;
        window.getDocs = getDocs;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.ref = ref;
        window.uploadBytes = uploadBytes;

        window.APP_ID = firebaseConfig.projectId;
        window.PITCH_INPUT_BUCKET = "validatr-pitch-decks-input"; // Sostituisci con il nome esatto del tuo bucket di input
    </script>

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            /* Font Changed to Roboto */
            background-color: #f8fafc;
            /* slate-50 */
            min-height: 100vh;
            padding-bottom: 2rem;
        }

        .container-padding {
            padding-left: 1rem;
            padding-right: 1rem;
        }

        @media (min-width: 640px) {

            /* sm */
            .container-padding {
                padding-left: 2rem;
                padding-right: 2rem;
            }
        }

        @media (min-width: 1024px) {

            /* lg */
            .container-padding {
                padding-left: 4rem;
                padding-right: 4rem;
            }
        }

        .card {
            background-color: white;
            border-radius: 0.75rem;
            /* rounded-xl */
            padding: 1.5rem;
            /* p-6 */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            /* shadow-lg */
            border: 1px solid #e2e8f0;
            /* slate-200 */
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            /* Larghezza massima per il grafico */
            margin-left: auto;
            margin-right: auto;
            height: 500px;
            /* Altezza base per un buon numero di barre */
            max-height: 700px;
            /* Altezza massima */
        }

        @media (max-width: 768px) {

            /* Adattamento per tablet/mobile */
            .chart-container {
                height: 400px;
                /* Riduci altezza per schermi più piccoli */
            }
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0.75rem;
            z-index: 10;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            /* Light grey */
            border-top: 4px solid #0d9488;
            /* Teal */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .scorecard-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            background-color: #f8fafc;
            /* slate-50 */
            border-radius: 0.5rem;
            /* rounded-lg */
            border: 1px solid #e2e8f0;
            /* slate-200 */
            transition: background-color 0.3s ease-in-out, border-color 0.3s ease-in-out;
        }

        .scorecard-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        .scorecard-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #475569;
            text-align: center;
        }

        .score-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            font-family: 'Material Icons Outlined';
            font-weight: normal;
            font-style: normal;
            display: inline-block;
            line-height: 1;
            text-transform: none;
            letter-spacing: normal;
            word-wrap: normal;
            white-space: nowrap;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
            -moz-osx-font-smoothing: grayscale;
            font-feature-settings: 'liga';
        }

        /* Icon Colors (Aggiornate per i nuovi stati) */
        .score-class-investire {
            color: #10b981;
        }

        /* emerald-500 */
        .score-class-monitorare {
            color: #f59e0b;
        }

        /* amber-500 */
        .score-class-verificare {
            color: #f97316;
        }

        /* orange-600 */
        .score-class-pass {
            color: #ef4444;
        }

        /* red-500 */
        .score-class-default {
            color: #64748b;
        }

        /* slate-500 */

        /* Background Colors for Scorecards (Aggiornate per i nuovi stati) */
        .bg-class-investire {
            background-color: #d1fae5;
            border-color: #10b981;
        }

        /* emerald-100, emerald-500 */
        .bg-class-monitorare {
            background-color: #fef3c7;
            border-color: #f59e0b;
        }

        /* amber-100, amber-500 */
        .bg-class-verificare {
            background-color: #ffedd5;
            border-color: #f97316;
        }

        /* orange-100, orange-600 */
        .bg-class-pass {
            background-color: #fee2e2;
            border-color: #ef4444;
        }

        /* red-100, red-500 */
        .bg-class-default-scorecard {
            background-color: #f8fafc;
            border-color: #e2e8f0;
        }

        /* slate-50, slate-200 */



        /* Stile Cerchio Profilo */
        .profile-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #10b981;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.25rem;
            cursor: pointer;
            border: 2px solid #0d9488;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .profile-circle-icon {
            font-size: 1.75rem;
        }

        /* Stilizzazione specifica per il Doughnut Chart */
        .doughnut-chart-container {
            position: relative;
            width: 100%;
            max-width: 350px;
            /* Larghezza adeguata per un doughnut chart */
            height: 350px;
            /* Altezza adeguata */
            margin: 2rem auto;
            /* Centra il grafico */
        }

        /* Stili per il contenitore di uno slider singolo */
        .slider-container {
            display: flex;
            flex-direction: column;
        }

        /* Stili per la riga che contiene etichetta e valore percentuale */
        .slider-label-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .slider-label {
            font-weight: 500;
            color: #334155;
            /* slate-700 */
        }

        .slider-value {
            font-weight: 600;
            color: #0d9488;
            /* teal-600 */
            background-color: #f0fdfa;
            /* teal-50 */
            padding: 0.1rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        /* Stili per l'input di tipo range (lo slider) */
        .weight-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            /* slate-200 */
            border-radius: 5px;
            outline: none;
            transition: opacity .2s;
        }

        .weight-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #14b8a6;
            /* teal-500 */
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .weight-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #14b8a6;
            /* teal-500 */
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center">
    <header class="w-full bg-white shadow-lg border-b border-slate-200 fixed top-0 z-20">
        <div class="container-padding mx-auto py-4 flex flex-wrap items-center justify-between">
            <div class="flex items-center mb-4 md:mb-0">
                <img src="https://storage.googleapis.com/validatr-statics-assets/logo2.PNG" alt="VALIDATR Logo"
                    class="h-10 w-10 mr-3 rounded-md">
                <h1 class="text-2xl sm:text-3xl font-bold text-slate-900" data-i18n-key="app_title">VALIDATR™</h1>
            </div>

            <nav
                class="flex space-x-4 sm:space-x-6 mb-4 md:mb-0 order-3 md:order-2 w-full md:w-auto justify-center md:justify-start">
                <a href="#" id="navHome"
                    class="text-slate-700 font-medium hover:text-teal-600 focus:outline-none focus:text-teal-600"
                    data-i18n-key="nav_home">Home (Dashboard Dettagliata)</a>
                <a href="#" id="navDealFlow"
                    class="text-slate-700 font-medium hover:text-teal-600 focus:outline-none focus:text-teal-600"
                    data-i18n-key="nav_deal_flow">Deal Flow (Ranking Investitori)</a>
            </nav>

            <div id="authStatus" class="flex items-center text-slate-700 font-medium hidden order-2 md:order-3">
                <button id="uploadPitchButton"
                    class="mr-2 sm:mr-4 px-3 py-2 sm:px-4 bg-teal-600 text-white rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50 transition duration-200 flex items-center">
                    <span class="material-icons-outlined text-xl sm:mr-2">cloud_upload</span>
                    <span data-i18n-key="upload_pitch_button" class="hidden sm:inline">Carica Pitch</span>
                </button>
                <div id="profileCircle" class="profile-circle mr-2 sm:mr-3">
                    <span class="material-icons-outlined profile-circle-icon">person</span>
                </div>
                <div class="hidden lg:flex items-center">
                    <span data-i18n-key="welcome_message">Benvenuto</span>, <span id="userEmail"
                        class="ml-1 font-semibold text-teal-600"></span>!
                </div>
                <select id="languageSelector"
                    class="ml-2 sm:ml-4 px-2 py-1 rounded-lg border border-slate-300 bg-slate-50 text-slate-800 shadow-sm">
                    <option value="it">Italiano</option>
                    <option value="en">English</option>
                </select>
                <button id="logoutButton"
                    class="ml-2 px-3 py-2 sm:px-4 bg-red-500 text-white rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition duration-200"
                    data-i18n-key="logout_button">
                    Logout
                </button>
            </div>
        </div>
    </header>


    <div id="loginSection" class="w-full max-w-md card mt-[150px] md:mt-[120px] p-8 flex flex-col items-center">
        <h2 class="text-2xl font-semibold text-slate-800 mb-6" data-i18n-key="login_title">Accedi a VALIDATR™</h2>
        <input type="email" id="emailInput" placeholder="Email"
            class="w-full px-4 py-2 mb-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
            data-i18n-key="email_placeholder">
        <input type="password" id="passwordInput" placeholder="Password"
            class="w-full px-4 py-2 mb-6 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
            data-i18n-key="password_placeholder">
        <button id="loginButton"
            class="w-full px-6 py-3 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50 transition duration-200"
            data-i18n-key="login_button_text">
            Accedi
        </button>
        <p id="loginError" class="text-red-600 mt-4 hidden"></p>
        <p class="mt-4 text-slate-600" data-i18n-key="no_account_prompt">Non hai un account?
            <a href="#" id="showRegisterForm" class="text-teal-600 hover:text-teal-700 font-semibold"
                data-i18n-key="register_here_link">Registrati qui</a>
        </p>
    </div>

    <div id="registerSection"
        class="w-full max-w-md card mt-[150px] md:mt-[120px] p-8 flex flex-col items-center hidden">
        <h2 class="text-2xl font-semibold text-slate-800 mb-6" data-i18n-key="register_title">Registrati a VALIDATR™
        </h2>
        <input type="email" id="registerEmail" placeholder="Email"
            class="w-full px-4 py-2 mb-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
            data-i18n-key="email_placeholder">
        <input type="password" id="registerPassword" placeholder="Password"
            class="w-full px-4 py-2 mb-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
            data-i18n-key="password_placeholder">
        <input type="password" id="confirmPassword" placeholder="Conferma Password"
            class="w-full px-4 py-2 mb-6 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
            data-i18n-key="confirm_password_placeholder">
        <button id="registerButton"
            class="w-full px-6 py-3 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50 transition duration-200"
            data-i18n-key="register_button_text">
            Registrati
        </button>
        <p id="registerError" class="text-red-600 mt-4 hidden"></p>
        <p class="mt-4 text-slate-600" data-i18n-key="already_have_account_prompt">Hai già un account?
            <a href="#" id="showLoginForm" class="text-teal-600 hover:text-teal-700 font-semibold"
                data-i18n-key="login_here_link">Accedi qui</a>
        </p>
    </div>

    <main id="dashboardContent" class="w-full container-padding pt-[200px] md:pt-[120px] hidden">
        <div class="mx-auto max-w-7xl w-full">
            <div id="loadingOverlay" class="loading-overlay hidden">
                <div class="spinner"></div>
                <p class="ml-4 text-slate-700 text-lg" data-i18n-key="loading_data_message">Caricamento dati...</p>
            </div>

            <div id="homeDashboard" class="flex flex-col w-full">
                <header class="w-full mb-8">
                    <div
                        class="flex flex-col md:flex-row items-start md:items-center justify-between bg-white p-6 rounded-xl shadow-lg border border-slate-200 gap-4">

                        <div class="flex-grow w-full md:w-auto">
                            <div class="flex items-center">
                                <h2 class="text-xl sm:text-2xl font-bold text-slate-900"
                                    data-i18n-key="detailed_dashboard_title">Dashboard Analisi Dettagliata</h2>
                            </div>
                            <div id="scoreModeSelector" class="flex items-center space-x-6 mt-4">
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="scoreMode" value="validatr" checked
                                        class="form-radio h-5 w-5 text-teal-600 focus:ring-teal-500">
                                    <span class="ml-2 text-slate-700 font-medium">Score Validatr™</span>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="radio" name="scoreMode" value="custom"
                                        class="form-radio h-5 w-5 text-teal-600 focus:ring-teal-500">
                                    <span class="ml-2 text-slate-700 font-medium">Il Mio Score</span>
                                </label>
                            </div>
                        </div>

                        <div
                            class="flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 w-full md:w-auto">
                            <label for="documentSelector" class="text-slate-700 font-medium whitespace-nowrap"
                                data-i18n-key="select_pitch_deck_label">Seleziona Pitch Deck:</label>

                            <div class="relative w-full sm:w-auto">
                                <select id="documentSelector"
                                    class="w-full sm:w-auto pl-4 pr-10 py-2 appearance-none rounded-lg border border-slate-300 bg-slate-50 text-slate-800 shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                </select>

                                <button id="showSummaryBtn" title="Mostra Executive Summary"
                                    class="absolute inset-y-0 right-0 flex items-center pr-3 hidden">
                                    <span class="material-icons-outlined text-amber-500 text-lg">star</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </header>

                <section id="customWeightsSection" class="card lg:col-span-2 mb-8 hidden">
                    <h3 class="text-xl font-semibold text-slate-800 mb-2">Personalizza Pesi Variabili</h3>
                    <p class="text-slate-600 mb-6">Trascina gli slider per aggiustare l'importanza di ogni variabile. La
                        somma totale resterà sempre 100%. Il "Final Adjusted Score" verrà ricalcolato dinamicamente.</p>
                    <div id="weightsSlidersContainer" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4"></div>
                </section>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full">
                    <section class="card lg:col-span-2">
                        <h3 class="text-xl font-semibold text-slate-800 mb-6" data-i18n-key="general_summary_title">
                            Riepilogo Generale del Pitch Deck</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div class="scorecard-item"><span id="finalAdjustedScoreIcon"
                                    class="score-icon score-class-default">analytics</span>
                                <div id="finalAdjustedScoreValue" class="scorecard-value">--</div>
                                <div class="scorecard-label" data-i18n-key="score_finale_regolato_label">Score Finale
                                    Regolato</div>
                            </div>
                            <div class="scorecard-item"><span id="coherenceIndexIcon"
                                    class="score-icon score-class-default">alt_route</span>
                                <div id="coherenceIndexValue" class="scorecard-value">--</div>
                                <div class="scorecard-label" data-i18n-key="indice_coerenza_label">Indice di Coerenza
                                </div>
                            </div>
                            <div id="pitchClassCard" class="scorecard-item"><span id="pitchClassIcon"
                                    class="score-icon score-class-default">emoji_events</span>
                                <div id="pitchClassValue" class="scorecard-value">--</div>
                                <div class="scorecard-label" data-i18n-key="classe_pitch_label">Classe Pitch</div>
                            </div>
                        </div>
                        <div id="noCoreMetricsData" class="hidden text-center text-slate-500 mt-4"
                            data-i18n-key="no_summary_data">Nessun dato di riepilogo disponibile per questo pitch.</div>
                    </section>
                    <section class="card flex flex-col w-full">
                        <h3 class="text-xl font-semibold text-slate-800 mb-4" data-i18n-key="variables_scores_title">
                            Punteggi Variabili Valutate</h3>
                        <p class="text-slate-600 mb-6" data-i18n-key="variables_chart_desc">Questo grafico a barre
                            mostra i punteggi (0-100) assegnati a ciascuna delle 7 variabili chiave del pitch deck
                            selezionato. Passa il mouse sulle barre per leggere la motivazione.</p>
                        <div class="flex-grow flex items-center justify-center min-h-[300px]">
                            <div class="chart-container"><canvas id="variablesChart"></canvas></div>
                        </div>
                        <div id="noDataChart" class="hidden text-center text-slate-500 mt-4"
                            data-i18n-key="no_chart_data">Nessun dato disponibile per il grafico.</div>
                    </section>
                    <section class="card flex flex-col w-full">
                        <h3 class="text-xl font-semibold text-slate-800 mb-4" data-i18n-key="variables_details_title">
                            Dettaglio Variabili e Motivazioni</h3>
                        <p class="text-slate-600 mb-6" data-i18n-key="variables_table_desc">Questa tabella fornisce i
                            punteggi numerici e le motivazioni dettagliate per ogni variabile.</p>
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-[500px] bg-white rounded-lg overflow-hidden">
                                <thead>
                                    <tr class="bg-slate-100 text-left text-slate-600 uppercase text-sm">
                                        <th class="py-3 px-4 rounded-tl-lg" data-i18n-key="variable_header">Variabile
                                        </th>
                                        <th class="py-3 px-4" data-i18n-key="score_header">Punteggio</th>
                                        <th class="py-3 px-4 rounded-tr-lg" data-i18n-key="motivation_header">
                                            Motivazione</th>
                                    </tr>
                                </thead>
                                <tbody id="variablesTableBody" class="divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                        <div id="noDataTable" class="hidden text-center text-slate-500 mt-4"
                            data-i18n-key="no_table_data">Nessun dato disponibile per la tabella.</div>
                    </section>
                    <section class="card lg:col-span-2 mt-8 w-full">
                        <h3 class="text-xl font-semibold text-slate-800 mb-4" data-i18n-key="coherence_analysis_title">
                            Analisi Coerenza tra Variabili</h3>
                        <p class="text-slate-600 mb-6" data-i18n-key="coherence_section_desc">Questa sezione mostra la
                            distribuzione di coerenza tra le variabili e i dettagli per ogni coppia.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start w-full">
                            <div class="doughnut-chart-container"><canvas id="coherenceDoughnutChart"></canvas></div>
                            <div>
                                <div
                                    class="flex flex-col sm:flex-row items-start sm:items-center sm:space-x-4 mb-4 gap-2">
                                    <label for="coherencePairSelector"
                                        class="text-slate-700 font-medium whitespace-nowrap"
                                        data-i18n-key="select_pair_label">Seleziona Coppia:</label><select
                                        id="coherencePairSelector"
                                        class="px-4 py-2 rounded-lg border border-slate-300 bg-slate-50 text-slate-800 shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent w-full sm:w-auto"></select>
                                </div>
                                <div id="coherenceDetails" class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                    <p class="text-slate-700 font-medium mb-2"><span
                                            data-i18n-key="score_label">Punteggio:</span><span
                                            id="selectedCoherenceScore" class="font-bold text-slate-900 ml-1">--</span>
                                    </p>
                                    <p class="text-slate-700"><span
                                            data-i18n-key="motivation_label">Motivazione:</span><span
                                            id="selectedCoherenceMotivation" class="block mt-1 text-slate-800">Nessuna
                                            motivazione disponibile.</span></p>
                                </div>
                            </div>
                        </div>
                        <div id="noCoherenceData" class="hidden text-center text-slate-500 mt-4"
                            data-i18n-key="no_coherence_data">Nessun dato di coerenza disponibile per questo pitch.
                        </div>
                    </section>
                </div>
            </div>

            <div id="dealFlowDashboard" class="flex flex-col w-full hidden">
                <header class="w-full mb-8">
                    <div
                        class="flex flex-col sm:flex-row items-start sm:items-center justify-between bg-white p-6 rounded-xl shadow-lg border border-slate-200 gap-4">
                        <h2 class="text-xl sm:text-2xl font-bold text-slate-900" data-i18n-key="deal_flow_title">Deal
                            Flow: Ranking Pitch per Investitori</h2>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="pitchFilter" value="my" checked
                                    class="form-radio text-teal-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 font-medium" data-i18n-key="my_pitches_radio">I Miei
                                    Pitch</span>
                            </label>
                        </div>
                    </div>
                </header>

                <section class="card w-full">
                    <h3 class="text-xl font-semibold text-slate-800 mb-4" data-i18n-key="ranking_chart_title">Classifica
                        dei Pitch Deck (Score Finale Regolato)</h3>
                    <p class="text-slate-600 mb-6" data-i18n-key="ranking_chart_desc">Questo grafico mostra tutti i
                        pitch deck analizzati, ordinati in base al loro "Score Finale Regolato" in ordine decrescente. I
                        pitch con i punteggi più alti sono in cima, rappresentando le opportunità più promettenti.</p>
                    <div class="flex-grow flex items-center justify-center min-h-[300px]">
                        <div class="chart-container"><canvas id="rankingChart"></canvas></div>
                    </div>
                    <div id="noRankingData" class="hidden text-center text-slate-500 mt-4"
                        data-i18n-key="no_ranking_data">Nessun dato di ranking disponibile.</div>
                </section>
            </div>
        </div>
    </main>

    <div id="uploadModal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-lg mx-4">

            <div id="uploadDefaultView">
                <h2 class="text-2xl font-semibold text-slate-800 mb-6" data-i18n-key="upload_modal_title">Carica
                    Documenti per l'Analisi</h2>

                <div class="mb-4">
                    <label for="pitchDeckInput" class="block text-sm font-medium text-slate-700 mb-1">Pitch Deck (PDF,
                        obbligatorio)</label>
                    <input type="file" id="pitchDeckInput" accept=".pdf"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>

                <div class="mb-6">
                    <label for="businessPlanInput" class="block text-sm font-medium text-slate-700 mb-1">Business Plan
                        (PDF, opzionale)</label>
                    <input type="file" id="businessPlanInput" accept=".pdf"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
                </div>

                <button id="uploadFileBtn"
                    class="w-full px-6 py-3 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50 transition duration-200 flex items-center justify-center">
                    <span class="material-icons-outlined text-xl mr-2">cloud_upload</span>
                    <span data-i18n-key="upload_and_analyze_button">Carica e Analizza</span>
                </button>
                <p id="uploadStatusMessage" class="mt-4 text-center text-slate-700"></p>
                <button id="closeUploadModalBtn"
                    class="mt-6 w-full px-6 py-3 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300"
                    data-i18n-key="close_button">
                    Chiudi
                </button>
            </div>

            <div id="uploadProcessingView" class="hidden text-center py-8">
                <div class="spinner mx-auto mb-6"></div>
                <h3 class="text-xl font-semibold text-slate-800" data-i18n-key="upload_processing_title">Analisi in
                    corso...</h3>
                <p class="text-slate-600 mt-2" data-i18n-key="upload_processing_desc">Il tuo pitch deck è in fase di
                    analisi. La dashboard si aggiornerà automaticamente.</p>
            </div>

        </div>
    </div>

    <div id="summaryModal" class="fixed inset-0 z-50 bg-black bg-opacity-50 grid place-items-center p-4 hidden">
        <div class="card w-full max-w-2xl mx-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-slate-800" data-i18n-key="summary_modal_title">In sintesi</h3>
                <button id="closeSummaryModalBtn_icon" class="p-1 rounded-full hover:bg-slate-200">
                    <span class="material-icons-outlined text-slate-600">close</span>
                </button>
            </div>
            <p id="summaryModalText" class="text-slate-600 leading-relaxed max-h-80 overflow-y-auto"></p>
            <button id="closeSummaryModalBtn_main"
                class="mt-6 w-full sm:w-auto sm:float-right px-6 py-2 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300"
                data-i18n-key="close_button">Chiudi</button>
        </div>
    </div>

    <script type="module">
        // Elementi UI globali
        const loginSection = document.getElementById('loginSection');
        const registerSection = document.getElementById('registerSection');
        const dashboardContent = document.getElementById('dashboardContent');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginButton = document.getElementById('loginButton');
        const loginError = document.getElementById('loginError');
        const logoutButton = document.getElementById('logoutButton');
        const authStatus = document.getElementById('authStatus');
        const userEmailSpan = document.getElementById('userEmail');
        const navHome = document.getElementById('navHome');
        const navDealFlow = document.getElementById('navDealFlow');
        const profileCircle = document.getElementById('profileCircle');
        const uploadPitchButton = document.getElementById('uploadPitchButton');

        // Elementi del form di registrazione
        const showRegisterFormLink = document.getElementById('showRegisterForm');
        const showLoginFormLink = document.getElementById('showLoginForm');
        const registerEmailInput = document.getElementById('registerEmail');
        const registerPasswordInput = document.getElementById('registerPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const registerButton = document.getElementById('registerButton');
        const registerError = document.getElementById('registerError');

        // NUOVO: Elementi del Modal di Caricamento
        const uploadModal = document.getElementById('uploadModal');
        const closeUploadModalBtn = document.getElementById('closeUploadModalBtn');
        const fileInput = document.getElementById('fileInput');
        const uploadFileBtn = document.getElementById('uploadFileBtn');
        const uploadStatusMessage = document.getElementById('uploadStatusMessage');

        // Sezioni della Dashboard
        const homeDashboard = document.getElementById('homeDashboard');
        const dealFlowDashboard = document.getElementById('dealFlowDashboard');

        // Elementi della dashboard Home
        const documentSelector = document.getElementById('documentSelector');
        const variablesTableBody = document.getElementById('variablesTableBody');
        const variablesChartCanvas = document.getElementById('variablesChart');
        const coherencePairSelector = document.getElementById('coherencePairSelector');
        const selectedCoherenceScore = document.getElementById('selectedCoherenceScore');
        const selectedCoherenceMotivation = document.getElementById('selectedCoherenceMotivation');
        const coherenceDoughnutChartCanvas = document.getElementById('coherenceDoughnutChart');

        const noDataChartDiv = document.getElementById('noDataChart');
        const noDataTableDiv = document.getElementById('noDataTable');
        const noCoreMetricsDataDiv = document.getElementById('noCoreMetricsData');
        const noCoherenceDataDiv = document.getElementById('noCoherenceData');
        const finalAdjustedScoreValue = document.getElementById('finalAdjustedScoreValue');
        const finalAdjustedScoreIcon = document.getElementById('finalAdjustedScoreIcon');
        const coherenceIndexValue = document.getElementById('coherenceIndexValue');
        const coherenceIndexIcon = document.getElementById('coherenceIndexIcon');
        const pitchClassValue = document.getElementById('pitchClassValue');
        const pitchClassIcon = document.getElementById('pitchClassIcon');
        const pitchClassCard = document.getElementById('pitchClassCard');

        // Elementi della dashboard Deal Flow
        const rankingChartCanvas = document.getElementById('rankingChart');
        const noRankingDataDiv = document.getElementById('noRankingData');
        const pitchFilterRadios = document.querySelectorAll('input[name="pitchFilter"]');

        // Overlay di caricamento globale
        const loadingOverlay = document.getElementById('loadingOverlay');

        let variablesChart = null;
        let rankingChart = null;
        let coherenceDoughnutChart = null;
        let loadedAllData = {};

        const scoreModeSelector = document.getElementById('scoreModeSelector');
        const customWeightsSection = document.getElementById('customWeightsSection');
        const weightsSlidersContainer = document.getElementById('weightsSlidersContainer');

        const summaryModal = document.getElementById('summaryModal');
        const showSummaryBtn = document.getElementById('showSummaryBtn');
        const summaryModalText = document.getElementById('summaryModalText');
        const closeSummaryModalBtn_icon = document.getElementById('closeSummaryModalBtn_icon');
        const closeSummaryModalBtn_main = document.getElementById('closeSummaryModalBtn_main');

        let userWeights = {
            "Problema": 15,
            "Target": 15,
            "Soluzione": 15,
            "Mercato": 15,
            "MVP": 15,
            "Team": 15,
            "Ritorno Atteso": 10
        };

        // Funzioni (definite globalmente nello script del modulo precedente)
        const auth = window.firebaseAuth;
        const setPersistence = window.setPersistence;
        const browserSessionPersistence = window.browserSessionPersistence;
        const signInWithEmailAndPassword = window.signInWithEmailAndPassword;
        const signOut = window.signOut;
        const onAuthStateChanged = window.onAuthStateChanged;
        const createUserWithEmailAndPassword = window.createUserWithEmailAndPassword;
        const db = window.firebaseDb;
        const setDoc = window.setDoc;
        const APP_ID = window.APP_ID;
        const docRef = window.doc;
        const storage = window.firebaseStorage;
        const storageRef = window.ref;
        const uploadBytes = window.uploadBytes;
        const PITCH_INPUT_BUCKET = window.PITCH_INPUT_BUCKET;

        // --- Configurazione Internazionalizzazione (i18n) ---
        const translations = {
            it: {
                app_title: "VALIDATR™ - Dashboard Completa",
                nav_home: "Home (Dashboard Dettagliata)",
                nav_deal_flow: "Deal Flow (Ranking Investitori)",
                upload_pitch_button: "Carica Pitch",
                welcome_message: "Benvenuto",
                logout_button: "Logout",
                login_title: "Accedi a VALIDATR™",
                summary_modal_title: "In sintesi",
                email_placeholder: "Email",
                password_placeholder: "Password",
                login_button_text: "Accedi",
                no_account_prompt: "Non hai un account? ",
                register_here_link: "Registrati qui",
                register_title: "Registrati a VALIDATR™",
                confirm_password_placeholder: "Conferma Password",
                register_button_text: "Registrati",
                already_have_account_prompt: "Hai già un account? ",
                login_here_link: "Accedi qui",
                loading_data_message: "Caricamento dati...",
                detailed_dashboard_title: "Dashboard Analisi Dettagliata",
                select_pitch_deck_label: "Seleziona Pitch Deck:",
                no_pitch_deck_available: "Nessun Pitch Deck disponibile",
                general_summary_title: "Riepilogo Generale del Pitch Deck",
                score_finale_regolato_label: "Score Finale Regolato",
                indice_coerenza_label: "Indice di Coerenza",
                classe_pitch_label: "Classe Pitch",
                no_summary_data: "Nessun dato di riepilogo disponibile per questo pitch.",
                variables_scores_title: "Punteggi Variabili Valutate",
                variables_chart_desc: "Questo grafico a barre mostra i punteggi (0-100) assegnati a ciascuna delle 7 variabili chiave del pitch deck selezionato. Passa il mouse sulle barre per leggere la motivazione.",
                variables_details_title: "Dettaglio Variabili e Motivazioni",
                variables_table_desc: "Questa tabella fornisce i punteggi numerici e le motivazioni dettagliate per ogni variabile.",
                variable_header: "Variabile",
                score_header: "Punteggio",
                motivation_header: "Motivazione",
                coherence_analysis_title: "Analisi Coerenza tra Variabili",
                coherence_section_desc: "Questa sezione mostra la distribuzione di coerenza tra le variabili e i dettagli per ogni coppia.",
                select_pair_label: "Seleziona Coppia:",
                score_label: "Punteggio:",
                motivation_label: "Motivazione:",
                no_coherence_data: "Nessun dato di coerenza disponibile per questo pitch.",
                deal_flow_title: "Deal Flow: Ranking Pitch per Investitori",
                my_pitches_radio: "I Miei Pitch",
                ranking_chart_title: "Classifica dei Pitch Deck (Score Finale Regolato)",
                ranking_chart_desc: "Questo grafico mostra tutti i pitch deck analizzati, ordinati in base al loro \"Score Finale Regolato\" in ordine decrescente. I pitch con i punteggi più alti sono in cima, rappresentando le opportunità più promettenti.",
                no_ranking_data: "Nessun dato di ranking disponibile.",
                upload_modal_title: "Carica un Nuovo Pitch Deck",
                upload_modal_desc: "Seleziona un file PDF da caricare per l'analisi.",
                upload_file_button: "Carica File",
                close_button: "Chiudi",
                upload_select_file: "Seleziona un file PDF.",
                upload_must_be_pdf: "Il file deve essere un PDF.",
                upload_must_be_logged_in: "Devi essere loggato per caricare il file.",
                upload_in_progress: "Caricamento in corso...",
                upload_completed: "Caricamento completato! L'analisi inizierà a breve.",
                upload_error: "Errore di caricamento:",
                high_coherence: "Alta Coerenza",
                low_coherence: "Bassa Coerenza",
                login_missing_credentials: "Per favore, inserisci email e password.",
                login_generic_error: "Errore durante l'accesso. Riprova.",
                login_invalid_email: "Email non valida.",
                login_user_disabled: "Il tuo account è stato disabilitato.",
                login_invalid_credentials: "Credenziali non valide. Controlla email e password.",
                login_too_many_requests: "Troppi tentativi di accesso falliti. Riprova più tardi.",
                error_prefix: "Errore",
                logout_error_prefix: "Errore durante il logout",
                register_missing_fields: "Per favore, compila tutti i campi.",
                register_password_too_short: "La password deve essere lunga almeno 6 caratteri.",
                register_passwords_not_match: "Le password non corrispondono.",
                register_generic_error: "Errore durante la registrazione. Riprova.",
                register_email_in_use: "Questa email è già in uso.",
                register_invalid_email: "Email non valida.",
                register_weak_password: "La password è troppo debole. Deve essere più robusta.",
                no_motivation_available: "Nessuna motivazione disponibile.",
                login_to_view_dashboard: "Accedi per visualizzare la dashboard.",
                no_ranking_data_for_pitches: "Nessun dato di ranking disponibile per {filterType}.",
                variable_Problema: "Problema",
                variable_Target: "Target",
                variable_Soluzione: "Soluzione",
                variable_Mercato: "Mercato",
                variable_MVP: "MVP",
                variable_Team: "Team",
                variable_RitornoAtteso: "Ritorno Atteso",
                class_INVESTIRE: "INVESTIRE",
                class_MONITORARE: "MONITORARE",
                class_VERIFICARE: "VERIFICARE",
                class_PASS: "PASS",
                chart_score_label: "Punteggio (0-100)",
                chart_variable_label: "Variabile",
                chart_pitch_deck_label: "Pitch Deck",
                upload_processing_title: "Analisi in corso...",
                upload_processing_desc: "Il tuo pitch deck è in fase di analisi. La dashboard si aggiornerà automaticamente.",
                upload_success_analysis_starts: "Caricamento completato! Inizio dell'analisi..."
            },
            en: {
                app_title: "VALIDATR™ - Complete Dashboard",
                nav_home: "Home (Detailed Dashboard)",
                nav_deal_flow: "Deal Flow (Investor Ranking)",
                upload_pitch_button: "Upload Pitch",
                welcome_message: "Welcome",
                logout_button: "Logout",
                login_title: "Login to VALIDATR™",
                email_placeholder: "Email",
                password_placeholder: "Password",
                login_button_text: "Login",
                no_account_prompt: "Don't have an account? ",
                register_here_link: "Register here",
                register_title: "Register for VALIDATR™",
                confirm_password_placeholder: "Confirm Password",
                register_button_text: "Register",
                summary_modal_title: "Executive Summary",
                already_have_account_prompt: "Already have an account? ",
                login_here_link: "Login here",
                loading_data_message: "Loading data...",
                detailed_dashboard_title: "Detailed Analysis Dashboard",
                select_pitch_deck_label: "Select Pitch Deck:",
                no_pitch_deck_available: "No Pitch Deck available",
                general_summary_title: "General Pitch Deck Summary",
                score_finale_regolato_label: "Final Adjusted Score",
                indice_coerenza_label: "Coherence Index",
                classe_pitch_label: "Pitch Class",
                no_summary_data: "No summary data available for this pitch.",
                variables_scores_title: "Evaluated Variable Scores",
                variables_chart_desc: "This bar chart shows the scores (0-100) assigned to each of the 7 key pitch deck variables. Hover over the bars to read the motivation.",
                variables_details_title: "Variable Details and Motivations",
                variables_table_desc: "This table provides the numerical scores and detailed motivations for each variable.",
                variable_header: "Variable",
                score_header: "Score",
                motivation_header: "Motivation",
                coherence_analysis_title: "Coherence Analysis Between Variables",
                coherence_section_desc: "This section shows the coherence distribution between variables and details for each pair.",
                select_pair_label: "Select Pair:",
                score_label: "Score:",
                motivation_label: "Motivation:",
                no_coherence_data: "No coherence data available for this pitch.",
                deal_flow_title: "Deal Flow: Investor Pitch Ranking",
                my_pitches_radio: "My Pitches",
                ranking_chart_title: "Pitch Deck Ranking (Final Adjusted Score)",
                ranking_chart_desc: "This chart displays all analyzed pitch decks, ordered by their \"Final Adjusted Score\" in descending order. Pitches with higher scores are at the top, representing the most promising opportunities.",
                no_ranking_data: "No ranking data available.",
                upload_modal_title: "Upload New Pitch Deck",
                upload_modal_desc: "Select a PDF file to upload for analysis.",
                upload_file_button: "Upload File",
                close_button: "Close",
                upload_select_file: "Select a PDF file.",
                upload_must_be_pdf: "The file must be a PDF.",
                upload_must_be_logged_in: "You must be logged in to upload the file.",
                upload_in_progress: "Upload in progress...",
                upload_completed: "Upload complete! Analysis will start shortly.",
                upload_error: "Upload error:",
                high_coherence: "High Coherence",
                low_coherence: "Low Coherence",
                login_missing_credentials: "Please enter email and password.",
                login_generic_error: "Error during login. Please try again.",
                login_invalid_email: "Invalid email.",
                login_user_disabled: "Your account has been disabled.",
                login_invalid_credentials: "Invalid credentials. Please check your email and password.",
                login_too_many_requests: "Too many failed login attempts. Please try again later.",
                error_prefix: "Error",
                logout_error_prefix: "Error during logout",
                register_missing_fields: "Please fill in all fields.",
                register_password_too_short: "Password must be at least 6 characters long.",
                register_passwords_not_match: "Passwords do not match.",
                register_generic_error: "Error during registration. Please try again.",
                register_email_in_use: "This email is already in use.",
                register_invalid_email: "Invalid email.",
                register_weak_password: "Password is too weak. It needs to be more robust.",
                no_motivation_available: "No motivation available.",
                login_to_view_dashboard: "Please log in to view the dashboard.",
                no_ranking_data_for_pitches: "No ranking data available for {filterType}.",
                // NUOVE CHIAVI AGGIUNTE PER I DATI DINAMICI
                variable_Problema: "Problem",
                variable_Target: "Target",
                variable_Soluzione: "Solution",
                variable_Mercato: "Market",
                variable_MVP: "MVP",
                variable_Team: "Team",
                variable_RitornoAtteso: "Expected Return",
                class_INVESTIRE: "INVEST",
                class_MONITORARE: "MONITOR",
                class_VERIFICARE: "VERIFY",
                class_PASS: "PASS",
                chart_score_label: "Score (0-100)",
                chart_variable_label: "Variable",
                chart_pitch_deck_label: "Pitch Deck",
                upload_processing_title: "Analysis in progress...",
                upload_processing_desc: "Your pitch deck is being analyzed. The dashboard will update automatically.",
                upload_success_analysis_starts: "Upload complete! Starting analysis..."
            }
        };

        let currentLanguage = 'it'; // Default language

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang); // Save language preference
            document.documentElement.lang = lang; // Set lang attribute on <html>

            // Update all elements with data-i18n-key
            document.querySelectorAll('[data-i18n-key]').forEach(element => {
                const key = element.getAttribute('data-i18n-key');
                if (translations[lang] && translations[lang][key]) {
                    // Handle placeholder attributes separately
                    if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                        element.setAttribute('placeholder', translations[lang][key]);
                    } else if (element.tagName === 'IMG' && element.hasAttribute('alt')) {
                        element.setAttribute('alt', translations[lang][key]);
                    } else if (element.tagName === 'A' && element.hasAttribute('title')) {
                        element.setAttribute('title', translations[lang][key]);
                    }
                    else {
                        element.textContent = translations[lang][key];
                    }
                }
            });

            // Update specific dynamic texts (messages, etc.)
            if (window.firebaseAuth.currentUser) {
                userEmailSpan.textContent = window.firebaseAuth.currentUser.email; // Email text content is NOT translated
                profileCircle.textContent = window.firebaseAuth.currentUser.email ? window.firebaseAuth.currentUser.email.charAt(0).toUpperCase() : 'U';
            }

            // Update messages
            noDataChartDiv.textContent = translations[currentLanguage].no_chart_data;
            noDataTableDiv.textContent = translations[currentLanguage].no_table_data;
            noCoreMetricsDataDiv.textContent = translations[currentLanguage].no_summary_data;
            noCoherenceDataDiv.textContent = translations[currentLanguage].no_coherence_data;
            noRankingDataDiv.textContent = translations[currentLanguage].no_ranking_data;

            // Re-render charts to update labels if needed
            if (window.firebaseAuth.currentUser && Object.keys(loadedAllData).length > 0) {
                // Se c'è un documento selezionato, lo aggiorna, altrimenti prende il primo disponibile
                const currentSelectedDocId = documentSelector.value;
                if (currentSelectedDocId && loadedAllData[currentSelectedDocId]) {
                    updateMainDashboard(currentSelectedDocId);
                } else if (Object.keys(loadedAllData).length > 0) {
                    updateMainDashboard(Object.keys(loadedAllData)[0]); // Se non c'è selezione, prendi il primo
                } else {
                    clearMainDashboard(); // Nessun dato, pulisci
                }

                fetchAndRenderRanking(document.querySelector('input[name="pitchFilter"]:checked').value); // Re-render ranking
            }
        }

        function loadLanguage() {
            let lang = localStorage.getItem('language');
            if (!lang) {
                // Detect browser language and use 'it' or 'en'
                const browserLang = navigator.language.split('-')[0];
                lang = (browserLang === 'it' || browserLang === 'en') ? browserLang : 'it';
            }
            document.getElementById('languageSelector').value = lang; // Set dropdown value
            setLanguage(lang);
        }

        // Function to display an authentication section and hide others
        function showAuthSection(sectionId) {
            loginSection.classList.add('hidden');
            registerSection.classList.add('hidden');
            if (sectionId === 'login') {
                loginSection.classList.remove('hidden');
            } else if (sectionId === 'register') {
                registerSection.classList.remove('hidden');
            }
        }

        // Function to display a dashboard section and hide others
        function showDashboardSection(sectionId) {
            homeDashboard.classList.add('hidden');
            dealFlowDashboard.classList.add('hidden');
            if (sectionId === 'home') {
                homeDashboard.classList.remove('hidden');
                if (auth.currentUser) {
                    fetchDataInBothDashboards(auth.currentUser);
                }
            } else if (sectionId === 'dealFlow') {
                dealFlowDashboard.classList.remove('hidden');
                if (auth.currentUser) {
                    fetchAndRenderRanking('my');
                }
            }
        }

        // Function to wrap long labels in charts
        function wrapLabel(label, maxCharPerLine) {
            if (typeof label !== 'string') return label;
            if (label.length <= maxCharPerLine) return label;
            let wrappedLabel = [];
            let words = label.split(' ');
            let currentLine = '';
            words.forEach((word, index) => {
                if ((currentLine + word).length <= maxCharPerLine) {
                    currentLine += (currentLine === '' ? '' : ' ') + word;
                } else {
                    wrappedLabel.push(currentLine);
                    currentLine = word;
                }
                if (index === words.length - 1) {
                    wrappedLabel.push(currentLine);
                }
            });
            return wrappedLabel;
        }

        // Function to clear the main dashboard
        function clearMainDashboard() {
            finalAdjustedScoreValue.textContent = '--';
            coherenceIndexValue.textContent = '--';
            pitchClassValue.textContent = '--';
            finalAdjustedScoreIcon.className = 'score-icon score-class-default';
            coherenceIndexIcon.className = 'score-icon score-class-default';
            pitchClassIcon.className = 'score-icon score-class-default';
            finalAdjustedScoreIcon.textContent = 'analytics';
            coherenceIndexIcon.textContent = 'alt_route';
            pitchClassIcon.textContent = 'emoji_events';

            showSummaryBtn.classList.add('hidden');

            pitchClassCard.classList.remove('bg-class-investire', 'bg-class-monitorare', 'bg-class-verificare', 'bg-class-pass');
            pitchClassCard.classList.add('bg-class-default-scorecard');

            variablesTableBody.innerHTML = '';

            coherencePairSelector.innerHTML = '<option value="">' + translations[currentLanguage].select_pair_label + '</option>';
            coherencePairSelector.disabled = true;
            selectedCoherenceScore.textContent = '--';
            selectedCoherenceMotivation.textContent = translations[currentLanguage].no_motivation_available;

            noDataChartDiv.classList.remove('hidden');
            noDataTableDiv.classList.remove('hidden');
            noCoreMetricsDataDiv.classList.remove('hidden');
            noCoherenceDataDiv.classList.remove('hidden');

            noDataChartDiv.textContent = translations[currentLanguage].no_chart_data;
            noDataTableDiv.textContent = translations[currentLanguage].no_table_data;
            noCoreMetricsDataDiv.textContent = translations[currentLanguage].no_summary_data;
            noCoherenceDataDiv.textContent = translations[currentLanguage].no_coherence_data;

            if (variablesChart) { variablesChart.destroy(); variablesChart = null; variablesChartCanvas.style.display = 'none'; }
            if (coherenceDoughnutChart) { coherenceDoughnutChart.destroy(); coherenceDoughnutChart = null; coherenceDoughnutChartCanvas.style.display = 'none'; }
        }

        // Function to update the main dashboard (detailed variables)
        function updateMainDashboard(selectedDocumentId) {
            const documentData = loadedAllData[selectedDocumentId];

            console.log("DEBUG: --- Inizio updateMainDashboard ---");
            console.log("DEBUG: selectedDocumentId:", selectedDocumentId);
            console.log("DEBUG: documentData (completo):", documentData); // VEDI QUI LA STRUTTURA GENERALE

            // Controlla la sezione core_metrics
            console.log("DEBUG: documentData.core_metrics:", documentData.core_metrics);
            if (documentData.core_metrics) {
                console.log("DEBUG: coreMetrics.final_adjusted_score:", documentData.core_metrics.final_adjusted_score);
                console.log("DEBUG: coreMetrics.classe_pitch:", documentData.core_metrics.classe_pitch);
            }

            // Controlla la sezione variables
            console.log("DEBUG: documentData.variables:", documentData.variables);
            if (documentData.variables && documentData.variables.length > 0) {
                console.log("DEBUG: Prima variabile:", documentData.variables[0]);
                console.log("DEBUG: Motivazione della prima variabile:", documentData.variables[0].motivazione_variabile);
                console.log("DEBUG: Motivazione della prima variabile (IT):", documentData.variables[0].motivazione_variabile.it);
                console.log("DEBUG: Motivazione della prima variabile (EN):", documentData.variables[0].motivazione_variabile.en);
            }

            console.log("Valore di executive_summary:", documentData.executive_summary);

            if (documentData && documentData.executive_summary && typeof documentData.executive_summary === 'object') {
                // Seleziona la traduzione corretta, con fallback sull'italiano
                summaryModalText.textContent = documentData.executive_summary[currentLanguage] || documentData.executive_summary.it;
                showSummaryBtn.classList.remove('hidden');
            } else {
                showSummaryBtn.classList.add('hidden');
            }

            // Controlla la sezione coherence_pairs
            console.log("DEBUG: documentData.coherence_pairs:", documentData.coherence_pairs);
            if (documentData.coherence_pairs && documentData.coherence_pairs.length > 0) {
                console.log("DEBUG: Prima coppia di coerenza:", documentData.coherence_pairs[0]);
                console.log("DEBUG: Motivazione della prima coppia di coerenza:", documentData.coherence_pairs[0].motivazione_coppia);
                console.log("DEBUG: Motivazione della prima coppia di coerenza (IT):", documentData.coherence_pairs[0].motivazione_coppia.it);
                console.log("DEBUG: Motivazione della prima coppia di coerenza (EN):", documentData.coherence_pairs[0].motivazione_coppia.en);
            }
            console.log("DEBUG: currentLanguage:", currentLanguage);
            console.log("DEBUG: --- Fine Inizio updateMainDashboard ---");


            noCoreMetricsDataDiv.classList.add('hidden');
            noDataChartDiv.classList.add('hidden');
            noDataTableDiv.classList.add('hidden');
            noCoherenceDataDiv.classList.add('hidden');
            variablesChartCanvas.style.display = 'none';
            if (coherenceDoughnutChartCanvas) coherenceDoughnutChartCanvas.style.display = 'none';

            if (!documentData) {
                clearMainDashboard();
                return;
            }

            const selectedMode = document.querySelector('input[name="scoreMode"]:checked').value;

            if (selectedMode === 'validatr') {
                customWeightsSection.classList.add('hidden');
                // Ripristina il valore originale dal backend
                if (documentData && documentData.core_metrics) {
                    finalAdjustedScoreValue.textContent = documentData.core_metrics.final_adjusted_score ? documentData.core_metrics.final_adjusted_score.toFixed(2) : '--';
                }
            } else {
                customWeightsSection.classList.remove('hidden');
                initializeSliders(); // Crea o aggiorna gli slider
                recalculateAndDisplayMyScore(); // Esegui subito il primo calcolo
            }

            // Update summary scorecards (using core_metrics)
            if (documentData.core_metrics) {
                const coreMetrics = documentData.core_metrics;
                finalAdjustedScoreValue.textContent = coreMetrics.final_adjusted_score ? coreMetrics.final_adjusted_score.toFixed(2) : '--';
                coherenceIndexValue.textContent = coreMetrics.indice_coerenza ? coreMetrics.indice_coerenza.toFixed(2) : '--';

                // Translate Pitch Class
                const pitchClassKey = `class_${coreMetrics.classe_pitch}`;
                pitchClassValue.textContent = translations[currentLanguage][pitchClassKey] || coreMetrics.classe_pitch || '--';

                const scorecardClasses = ['bg-class-investire', 'bg-class-monitorare', 'bg-class-verificare', 'bg-class-pass', 'bg-class-default-scorecard'];
                pitchClassCard.classList.remove(...scorecardClasses);

                // Reintegrated icon and card background color logic based on pitch class
                finalAdjustedScoreIcon.className = 'score-icon';
                coherenceIndexIcon.className = 'score-icon';
                pitchClassIcon.className = 'score-icon';
                finalAdjustedScoreIcon.textContent = 'analytics';
                coherenceIndexIcon.textContent = 'alt_route';
                pitchClassIcon.textContent = 'emoji_events';

                const currentClass = coreMetrics.classe_pitch;
                if (currentClass === 'INVESTIRE') {
                    finalAdjustedScoreIcon.classList.add('score-class-investire');
                    coherenceIndexIcon.classList.add('score-class-investire');
                    pitchClassIcon.classList.add('score-class-investire');
                    pitchClassCard.classList.add('bg-class-investire');
                } else if (currentClass === 'MONITORARE') {
                    finalAdjustedScoreIcon.classList.add('score-class-monitorare');
                    coherenceIndexIcon.classList.add('score-class-monitorare');
                    pitchClassIcon.classList.add('score-class-monitorare');
                    pitchClassCard.classList.add('bg-class-monitorare');
                } else if (currentClass === 'VERIFICARE') {
                    finalAdjustedScoreIcon.classList.add('score-class-verificare');
                    coherenceIndexIcon.classList.add('score-class-verificare');
                    pitchClassIcon.classList.add('score-class-verificare');
                    pitchClassCard.classList.add('bg-class-verificare');
                } else if (currentClass === 'PASS') {
                    finalAdjustedScoreIcon.classList.add('score-class-pass');
                    coherenceIndexIcon.classList.add('score-class-pass');
                    pitchClassIcon.classList.add('score-class-pass');
                    pitchClassCard.classList.add('bg-class-pass');
                } else {
                    finalAdjustedScoreIcon.classList.add('score-class-default');
                    coherenceIndexIcon.classList.add('score-class-default');
                    pitchClassIcon.classList.add('score-class-default');
                    pitchClassCard.classList.add('bg-class-default-scorecard');
                }
            } else {
                noCoreMetricsDataDiv.classList.remove('hidden');
            }

            // Update Variables Chart and Table (use variables)
            if (documentData.variables && documentData.variables.length > 0) {
                variablesChartCanvas.style.display = 'block';
                noDataChartDiv.classList.add('hidden');
                noDataTableDiv.classList.add('hidden');

                const labels = documentData.variables.map(v => {
                    const translationKey = `variable_${v.nome_variabile.replace(/\s/g, '')}`;
                    return wrapLabel(translations[currentLanguage][translationKey] || v.nome_variabile, 16);
                });
                const scores = documentData.variables.map(v => v.punteggio_variabile);
                const motivations = documentData.variables.map(v => v.motivazione_variabile);

                // Reintegrated barColor and borderColor logic based on pitch class
                const barColor = (score) => {
                    const currentClass = documentData.core_metrics?.classe_pitch;
                    if (currentClass === 'INVESTIRE') return '#10b981'; /* emerald-500 */
                    if (currentClass === 'MONITORARE') return '#f59e0b'; /* amber-500 */
                    if (currentClass === 'VERIFICARE') return '#f97316'; /* orange-600 */
                    if (currentClass === 'PASS') return '#ef4444'; /* red-500 */
                    return '#cbd5e1'; /* slate-300 */
                };
                const borderColor = (score) => {
                    const currentClass = documentData.core_metrics?.classe_pitch;
                    if (currentClass === 'INVESTIRE') return '#059669'; /* emerald-600 */
                    if (currentClass === 'MONITORARE') return '#d97706'; /* amber-600 */
                    if (currentClass === 'VERIFICARE') return '#ea580c'; /* orange-700 */
                    if (currentClass === 'PASS') return '#dc2626'; /* red-600 */
                    return '#94a3b8'; /* slate-400 */
                };

                if (variablesChart) {
                    variablesChart.data.labels = labels;
                    variablesChart.data.datasets[0].data = scores;
                    variablesChart.data.datasets[0].motivations = motivations;
                    variablesChart.data.datasets[0].backgroundColor = scores.map(barColor); // Use the new barColor function
                    variablesChart.data.datasets[0].borderColor = scores.map(borderColor);   // Use the new borderColor function
                    variablesChart.update();
                } else {
                    const ctx = variablesChartCanvas.getContext('2d');
                    variablesChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: translations[currentLanguage].score_header,
                                data: scores,
                                backgroundColor: scores.map(barColor), // Use the new barColor function
                                borderColor: scores.map(borderColor),   // Use the new borderColor function
                                borderWidth: 1,
                                motivations: motivations
                            }]
                        },
                        options: {
                            indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        title: (context) => Array.isArray(context[0].label) ? context[0].label.join(' ') : context[0].label,
                                        label: (context) => `${translations[currentLanguage].score_header}: ${context.parsed.x}`,
                                        afterLabel: (context) => {
                                            const motivation = context.dataset.motivations[context.dataIndex];
                                            return `${translations[currentLanguage].motivation_header}: ${(motivation[currentLanguage] || motivation.it || translations[currentLanguage].no_motivation_available)}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true, max: 100,
                                    title: { display: true, text: translations[currentLanguage].chart_score_label, color: '#475569' },
                                    ticks: { color: '#475569' }, grid: { color: '#e2e8f0' }
                                },
                                y: {
                                    title: { display: true, text: translations[currentLanguage].chart_variable_label, color: '#475569' },
                                    ticks: { color: '#475569' }, grid: { color: '#e2e8f0' }
                                }
                            }
                        }
                    });
                }

                // Update Variables Table
                variablesTableBody.innerHTML = '';
                documentData.variables.forEach(v => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-slate-200 text-slate-700';

                    const nameCell = document.createElement('td');
                    nameCell.className = 'py-3 px-4';
                    const translationKey = `variable_${v.nome_variabile.replace(/\s/g, '')}`;
                    nameCell.textContent = translations[currentLanguage][translationKey] || v.nome_variabile;
                    tr.appendChild(nameCell);

                    const scoreCell = document.createElement('td');
                    scoreCell.className = 'py-3 px-4 text-center font-medium';
                    scoreCell.textContent = v.punteggio_variabile;
                    tr.appendChild(scoreCell);

                    const motivationCell = document.createElement('td');
                    motivationCell.className = 'py-3 px-4 text-sm';
                    motivationCell.textContent = v.motivazione_variabile[currentLanguage] || v.motivazione_variabile.it || translations[currentLanguage].no_motivation_available;
                    tr.appendChild(motivationCell);

                    variablesTableBody.appendChild(tr);
                });
            } else {
                variablesChartCanvas.style.display = 'none';
                variablesTableBody.innerHTML = '';
                noDataChartDiv.classList.remove('hidden');
                noDataTableDiv.classList.remove('hidden');
                if (variablesChart) variablesChart.destroy();
            }

            // Update Coherence Details with Dropdown (use coherence_pairs)
            if (documentData.coherence_pairs && documentData.coherence_pairs.length > 0) {
                noCoherenceDataDiv.classList.add('hidden'); // Nasconde il messaggio "nessun dato"
                coherenceDoughnutChartCanvas.style.display = 'block'; // Mostra l'area del grafico

                // --- POPOLA IL MENU A TENDINA ---
                coherencePairSelector.innerHTML = '<option value="">' + translations[currentLanguage].select_pair_label + '</option>';
                documentData.coherence_pairs.forEach((cp, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    const [var1, var2] = cp.nome_coppia.split(' - ');
                    const translatedVar1 = translations[currentLanguage][`variable_${var1.replace(/\s/g, '')}`] || var1;
                    const translatedVar2 = translations[currentLanguage][`variable_${var2.replace(/\s/g, '')}`] || var2;
                    option.textContent = `${translatedVar1} - ${translatedVar2}`;
                    coherencePairSelector.appendChild(option);
                });
                coherencePairSelector.disabled = false;

                // --- FUNZIONE PER AGGIORNARE I DETTAGLI (PUNTEGGIO E MOTIVAZIONE) ---
                const updateSelectedCoherenceDetails = (selectedIndex) => {
                    // console.log('--- DEBUG: Chiamata updateSelectedCoherenceDetails con index:', selectedIndex);

                    // Controlla se l'indice non è valido (es. se è selezionata l'opzione di default)
                    if (selectedIndex === "" || !documentData.coherence_pairs[selectedIndex]) {
                        // console.log('--- DEBUG: Indice non valido. Imposto i valori di default.');
                        selectedCoherenceScore.textContent = '--';
                        selectedCoherenceMotivation.textContent = translations[currentLanguage].no_motivation_available || 'Nessuna motivazione disponibile.';
                        return;
                    }

                    // Ottieni l'oggetto con i dati della coppia selezionata
                    const selectedPair = documentData.coherence_pairs[selectedIndex];
                    // console.log('--- DEBUG: Dati della coppia recuperati:', selectedPair);

                    // Estrai punteggio e motivazione in variabili separate per chiarezza
                    const score = selectedPair.punteggio_coppia;
                    const motivationText = selectedPair.motivazione_coppia[currentLanguage] || selectedPair.motivazione_coppia.it || translations[currentLanguage].no_motivation_available;

                    // console.log('--- DEBUG: Punteggio che verrà visualizzato:', score);
                    // console.log('--- DEBUG: Motivazione che verrà visualizzata:', motivationText);

                    // Aggiorna gli elementi HTML con i nuovi valori
                    selectedCoherenceScore.textContent = score ?? '--';
                    selectedCoherenceMotivation.textContent = motivationText ?? 'Nessuna motivazione disponibile.';

                    // console.log('--- DEBUG: Update completato. Contenuto del box dettagli:', document.getElementById('coherenceDetails').innerHTML);
                };

                // Imposta il valore di default (la prima coppia) e aggiorna i dettagli
                coherencePairSelector.value = 0;
                updateSelectedCoherenceDetails(0);

                // Aggiunge l'evento per aggiornare i dettagli quando cambi la selezione
                coherencePairSelector.onchange = (event) => {
                    const selectedIndex = event.target.value !== "" ? parseInt(event.target.value) : "";
                    updateSelectedCoherenceDetails(selectedIndex);
                };

                // --- CREAZIONE DEL GRAFICO A CIAMBELLA (DOUGHNUT CHART) - PARTE MANCANTE ---
                const highCoherenceCount = documentData.coherence_pairs.filter(p => p.punteggio_coppia >= 75).length;
                const lowCoherenceCount = documentData.coherence_pairs.length - highCoherenceCount;

                if (coherenceDoughnutChart) {
                    coherenceDoughnutChart.destroy(); // Distrugge il grafico precedente per evitare duplicati
                }

                const doughnutCtx = coherenceDoughnutChartCanvas.getContext('2d');
                coherenceDoughnutChart = new Chart(doughnutCtx, {
                    type: 'doughnut',
                    data: {
                        labels: [
                            translations[currentLanguage].high_coherence, // Es: 'Alta Coerenza'
                            translations[currentLanguage].low_coherence   // Es: 'Bassa Coerenza'
                        ],
                        datasets: [{
                            data: [highCoherenceCount, lowCoherenceCount],
                            backgroundColor: ['#10b981', '#f59e0b'], // Colori per le sezioni
                            borderColor: ['#ffffff', '#ffffff'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { color: '#475569' }
                            },
                            title: {
                                display: true,
                                text: 'Distribuzione Coerenza',
                                color: '#475569'
                            }
                        }
                    }
                });

            } else { // Se non ci sono dati di coerenza
                coherenceDoughnutChartCanvas.style.display = 'none';
                coherencePairSelector.innerHTML = '<option value="">' + translations[currentLanguage].no_coherence_data + '</option>';
                coherencePairSelector.disabled = true;
                selectedCoherenceScore.textContent = '--';
                selectedCoherenceMotivation.textContent = translations[currentLanguage].no_motivation_available;
                noCoherenceDataDiv.classList.remove('hidden');
                if (coherenceDoughnutChart) {
                    coherenceDoughnutChart.destroy();
                    coherenceDoughnutChart = null;
                }
            }

            if (selectedMode === 'validatr') {
                customWeightsSection.classList.add('hidden');
                if (documentData && documentData.core_metrics) {
                    // Ripristina il punteggio originale
                    finalAdjustedScoreValue.textContent = documentData.core_metrics.final_adjusted_score ? documentData.core_metrics.final_adjusted_score.toFixed(2) : '--';

                    // --- LOGICA AGGIORNATA PER LA CLASSE PITCH ---
                    // Ripristina la classe pitch originale usando la funzione di supporto
                    updatePitchClassUI(documentData.core_metrics.classe_pitch);
                }
            } else {
                customWeightsSection.classList.remove('hidden');
                initializeSliders();
                recalculateAndDisplayMyScore();
            }
        }

        // Function to retrieve all dashboard data (Home and Deal Flow) from Cloud Function API
        async function fetchDataInBothDashboards(user) {
            if (!user) {
                console.log("User not authenticated. Cannot retrieve data.");
                loadingOverlay.classList.add('hidden');
                clearMainDashboard();
                return;
            }

            loadingOverlay.classList.remove('hidden'); // Show loading overlay

            try {
                const token = await user.getIdToken();
                const apiUrl = `https://europe-west1-validatr-mvp.cloudfunctions.net/fetchPitchData`;

                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        console.error("API access denied. You might not have permissions or the token expired.");
                        await signOut(auth); // Force logout
                        return;
                    }
                    throw new Error(`HTTP Error! Status: ${response.status}`);
                }
                const data = await response.json();

                loadedAllData = data;

                // Populate document selector for Home Dashboard
                documentSelector.innerHTML = '';
                if (Object.keys(loadedAllData).length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = translations[currentLanguage].no_pitch_deck_available;
                    documentSelector.appendChild(option);
                    documentSelector.disabled = true;
                    clearMainDashboard();
                } else {
                    documentSelector.disabled = false;
                    const sortedDocIds = Object.keys(loadedAllData).sort((a, b) => a.localeCompare(b));
                    sortedDocIds.forEach(docId => {
                        const option = document.createElement('option');
                        option.value = docId;
                        option.textContent = loadedAllData[docId].document_name || docId;
                        documentSelector.appendChild(option);
                    });
                    if (sortedDocIds.length > 0) {
                        documentSelector.value = sortedDocIds[0];
                        updateMainDashboard(sortedDocIds[0]);
                    }
                }

            } catch (error) {
                console.error("Error retrieving data from Cloud Function API:", error);
                clearMainDashboard();
            } finally {
                loadingOverlay.classList.add('hidden'); // Hide loading overlay
            }
        }


        // Function to render the ranking dashboard (uses already loaded data)
        async function fetchAndRenderRanking(filterType = 'my') {
            const user = auth.currentUser;
            if (!user) {
                console.log("User not authenticated. Cannot retrieve ranking data.");
                loadingOverlay.classList.add('hidden');
                noRankingDataDiv.classList.remove('hidden');
                noRankingDataDiv.textContent = translations[currentLanguage].login_to_view_dashboard;
                if (rankingChart) rankingChart.destroy();
                return;
            }

            if (Object.keys(loadedAllData).length === 0) {
                await fetchDataInBothDashboards(user);
            }

            const rankingData = [];
            for (const docId in loadedAllData) {
                const doc = loadedAllData[docId];
                if (doc.core_metrics && doc.core_metrics.final_adjusted_score !== undefined) {
                    rankingData.push({
                        name: doc.document_name || docId,
                        score: doc.core_metrics.final_adjusted_score
                    });
                }
            }

            rankingData.sort((a, b) => b.score - a.score);

            if (rankingData.length === 0) {
                rankingChartCanvas.style.display = 'none';
                noRankingDataDiv.classList.remove('hidden');
                noRankingDataDiv.textContent = `${translations[currentLanguage].no_ranking_data} per ${translations[currentLanguage][filterType + '_pitches']}.`;
                if (rankingChart) rankingChart.destroy();
                return;
            } else {
                rankingChartCanvas.style.display = 'block';
                noRankingDataDiv.classList.add('hidden');
            }

            const labels = rankingData.map(item => item.name);
            const scores = rankingData.map(item => item.score);

            const backgroundColors = [];
            const borderColors = [];
            const numItems = rankingData.length;

            for (let i = 0; i < numItems; i++) {
                const currentClass = loadedAllData[rankingData[i].name]?.core_metrics?.classe_pitch;
                if (currentClass === 'INVESTIRE') {
                    backgroundColors.push('#10b981');
                    borderColors.push('#059669');
                } else if (currentClass === 'MONITORARE') {
                    backgroundColors.push('#f59e0b');
                    borderColors.push('#d97706');
                } else if (currentClass === 'VERIFICARE') {
                    backgroundColors.push('#f97316');
                    borderColors.push('#ea580c');
                } else if (currentClass === 'PASS') {
                    backgroundColors.push('#ef4444');
                    borderColors.push('#dc2626');
                } else {
                    if (i === 0) { backgroundColors.push('#34D399'); borderColors.push('#059669'); }
                    else if (i === 1) { backgroundColors.push('#10B981'); borderColors.push('#047857'); }
                    else if (i === 2) { backgroundColors.push('#059669'); borderColors.push('#065F46'); }
                    else if (i >= numItems - 3 && numItems > 3) {
                        if (i === numItems - 1) { backgroundColors.push('#B91C1C'); borderColors.push('#7F1D1D'); }
                        else if (i === numItems - 2) { backgroundColors.push('#EF4444'); borderColors.push('#DC2626'); }
                        else { backgroundColors.push('#F87171'); borderColors.push('#EF4444'); }
                    } else {
                        backgroundColors.push('#FBBF24'); borderColors.push('#F59E0B');
                    }
                }
            }


            if (rankingChart) {
                rankingChart.data.labels = labels;
                rankingChart.data.datasets[0].data = scores;
                rankingChart.data.datasets[0].backgroundColor = backgroundColors;
                rankingChart.data.datasets[0].borderColor = borderColors;
                rankingChart.options.scales.x.title.text = translations[currentLanguage].score_finale_regolato_label + ' (0-100)';
                rankingChart.options.scales.y.title.text = translations[currentLanguage].chart_pitch_deck_label;
                rankingChart.update();
            } else {
                const ctx = rankingChartCanvas.getContext('2d');
                rankingChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: translations[currentLanguage].score_finale_regolato_label,
                            data: scores,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        return `${context.label}: ${context.parsed.x.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: translations[currentLanguage].score_finale_regolato_label + ' (0-100)',
                                    color: '#475569'
                                },
                                ticks: {
                                    color: '#475569'
                                },
                                grid: {
                                    color: '#e2e8f0'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: translations[currentLanguage].chart_pitch_deck_label,
                                    color: '#475569'
                                },
                                ticks: {
                                    color: '#475569'
                                },
                                grid: {
                                    color: '#e2e8f0'
                                }
                            }
                        }
                    }
                });
            }
        }

        /**
         * NUOVA FUNZIONE DI SUPPORTO
         * Aggiorna la UI della card "Classe Pitch" in base alla classe fornita.
         * @param {string} className - Il nome della classe (es. "INVESTIRE").
         */
        function updatePitchClassUI(className) {
            if (!className) return; // Non fare nulla se la classe non è valida

            const pitchClassKey = `class_${className}`;
            pitchClassValue.textContent = translations[currentLanguage][pitchClassKey] || className;

            // Definisci le classi CSS da manipolare
            const scorecardClasses = ['bg-class-investire', 'bg-class-monitorare', 'bg-class-verificare', 'bg-class-pass', 'bg-class-default-scorecard'];
            const iconClasses = ['score-class-investire', 'score-class-monitorare', 'score-class-verificare', 'score-class-pass', 'score-class-default'];

            const lowerCaseClass = className.toLowerCase();

            // Aggiorna il box "Classe Pitch" (logica esistente)
            pitchClassCard.classList.remove(...scorecardClasses);
            pitchClassCard.classList.add(`bg-class-${lowerCaseClass}`);
            pitchClassIcon.classList.remove(...iconClasses);
            pitchClassIcon.classList.add(`score-class-${lowerCaseClass}`);

            // --- NUOVO: Aggiorna le icone degli altri due box ---

            // 1. Aggiorna l'icona dello "Score Finale Regolato"
            finalAdjustedScoreIcon.classList.remove(...iconClasses);
            finalAdjustedScoreIcon.classList.add(`score-class-${lowerCaseClass}`);

            // 2. Aggiorna l'icona dell'"Indice di Coerenza"
            coherenceIndexIcon.classList.remove(...iconClasses);
            coherenceIndexIcon.classList.add(`score-class-${lowerCaseClass}`);
        }

        function recalculateAndDisplayMyScore() {
            const selectedDocId = documentSelector.value;
            if (!selectedDocId || !loadedAllData[selectedDocId]) return;

            const variables = loadedAllData[selectedDocId].variables;
            if (!variables || variables.length === 0) return;

            let newWeightedScore = 0;
            variables.forEach(variable => {
                const variableName = variable.nome_variabile;
                const variableScore = variable.punteggio_variabile;
                const weight = userWeights[variableName] / 100;
                newWeightedScore += variableScore * weight;
            });

            finalAdjustedScoreValue.textContent = newWeightedScore.toFixed(2);

            // --- LOGICA AGGIORNATA PER LA CLASSE PITCH ---

            // 1. Determina la nuova classe in base alle soglie
            let newClass = 'PASS'; // Classe di default
            if (newWeightedScore >= 77) {
                newClass = 'INVESTIRE';
            } else if (newWeightedScore >= 63) {
                newClass = 'MONITORARE';
            } else if (newWeightedScore >= 40) {
                newClass = 'VERIFICARE';
            }
            // 2. Chiama la funzione di supporto per aggiornare la UI
            updatePitchClassUI(newClass);
        }

        /**
         * NUOVA FUNZIONE
         * Gestisce il cambiamento di un singolo slider, ridistribuendo i pesi sugli altri.
         * @param {string} changedVarName - Il nome della variabile il cui slider è stato mosso.
         */
        function handleSliderChange(changedVarName) {
            const sliders = document.querySelectorAll('.weight-slider');
            const total = 100;
            let currentTotal = 0;

            // Calcola la somma attuale di tutti gli slider
            sliders.forEach(s => currentTotal += parseFloat(s.value));

            const changedSlider = document.querySelector(`.weight-slider[data-variable="${changedVarName}"]`);
            const changedValue = parseFloat(changedSlider.value);
            const oldValue = userWeights[changedVarName];
            const delta = changedValue - oldValue;

            userWeights[changedVarName] = changedValue; // Aggiorna il peso della variabile modificata

            // Se la somma non è 100, ridistribuisci la differenza sugli altri slider
            if (delta !== 0) {
                const otherSliders = Array.from(sliders).filter(s => s.dataset.variable !== changedVarName);
                let otherSlidersTotalWeight = 0;
                otherSliders.forEach(s => otherSlidersTotalWeight += userWeights[s.dataset.variable]);

                let remainingDelta = delta;

                // Distribuisci la differenza negativa
                for (const slider of otherSliders) {
                    const varName = slider.dataset.variable;
                    if (remainingDelta === 0) break;

                    const proportion = userWeights[varName] / otherSlidersTotalWeight;
                    let change = remainingDelta * proportion;

                    let newValue = userWeights[varName] - change;

                    // Assicurati che il nuovo valore non vada sotto zero
                    if (newValue < 0) {
                        change += newValue; // Riduci la modifica per non andare sotto zero
                        newValue = 0;
                    }

                    userWeights[varName] = newValue;
                    remainingDelta -= change;
                }
            }

            // Arrotonda e normalizza per evitare errori di calcolo con i float
            let finalTotal = 0;
            Object.keys(userWeights).forEach(key => finalTotal += userWeights[key]);

            const normalizationFactor = total / finalTotal;
            Object.keys(userWeights).forEach(key => {
                userWeights[key] *= normalizationFactor;
            });

            // Aggiorna la UI
            updateAllSlidersUI();
            recalculateAndDisplayMyScore();
        }

        /**
         * NUOVA FUNZIONE
         * Aggiorna la posizione e il valore testuale di tutti gli slider.
         */
        function updateAllSlidersUI() {
            Object.keys(userWeights).forEach(varName => {
                const slider = document.querySelector(`.weight-slider[data-variable="${varName}"]`);
                const valueSpan = document.querySelector(`.slider-value[data-variable="${varName}"]`);
                if (slider && valueSpan) {
                    const weight = userWeights[varName];
                    slider.value = weight;
                    valueSpan.textContent = `${weight.toFixed(1)}%`;
                }
            });
        }

        /**
         * NUOVA FUNZIONE
         * Crea e popola la sezione degli slider la prima volta.
         */
        function initializeSliders() {
            weightsSlidersContainer.innerHTML = ''; // Pulisci il contenitore
            const variableOrder = ["Problema", "Target", "Soluzione", "Mercato", "MVP", "Team", "Ritorno Atteso"];

            variableOrder.forEach(varName => {
                const weight = userWeights[varName];
                const translatedVarName = translations[currentLanguage][`variable_${varName.replace(/\s/g, '')}`] || varName;

                const sliderHTML = `
                    <div class="slider-container">
                        <div class="slider-label-container">
                            <label class="slider-label">${translatedVarName}</label>
                            <span class="slider-value" data-variable="${varName}">${weight.toFixed(1)}%</span>
                        </div>
                        <input type="range" min="0" max="100" step="0.1" value="${weight}" class="weight-slider" data-variable="${varName}">
                    </div>
                `;
                weightsSlidersContainer.innerHTML += sliderHTML;
            });

            // Aggiungi gli event listener
            document.querySelectorAll('.weight-slider').forEach(slider => {
                slider.addEventListener('input', (event) => {
                    handleSliderChange(event.target.dataset.variable);
                });
            });
        }


        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Load language when DOM is ready
            loadLanguage();

            // Language selector change listener
            document.getElementById('languageSelector').addEventListener('change', (event) => {
                setLanguage(event.target.value);
            });

            document.querySelectorAll('input[name="scoreMode"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    // Quando cambi modalità, riesegui l'aggiornamento della dashboard
                    // per mostrare/nascondere la sezione e ricalcolare.
                    updateMainDashboard(documentSelector.value);
                });
            });

            // Authentication Management
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("Utente loggato:", user.email);
                    userEmailSpan.textContent = user.email; // Email text content is NOT translated
                    profileCircle.textContent = user.email ? user.email.charAt(0).toUpperCase() : 'U';
                    authStatus.classList.remove('hidden');
                    loginSection.classList.add('hidden');
                    dashboardContent.classList.remove('hidden');
                    loginError.classList.add('hidden');

                    // On login, retrieve all data from Cloud Function API
                    await fetchDataInBothDashboards(user);

                    showDashboardSection('home');

                } else {
                    console.log("Utente disconnesso.");
                    authStatus.classList.add('hidden');
                    loginSection.classList.remove('hidden');
                    dashboardContent.classList.add('hidden');
                    showAuthSection('login');
                    if (variablesChart) { variablesChart.destroy(); variablesChart = null; }
                    if (rankingChart) { rankingChart.destroy(); rankingChart = null; }
                    if (coherenceDoughnutChart) { coherenceDoughnutChart.destroy(); coherenceDoughnutChart = null; }
                    clearMainDashboard();
                    loadedAllData = {};
                }
            });

            showSummaryBtn.addEventListener('click', () => {
                summaryModal.classList.remove('hidden');
            });

            const closeSummaryModal = () => {
                summaryModal.classList.add('hidden');
            };

            closeSummaryModalBtn_icon.addEventListener('click', closeSummaryModal);
            closeSummaryModalBtn_main.addEventListener('click', closeSummaryModal);

            summaryModal.addEventListener('click', (event) => {
                if (event.target === summaryModal) {
                    closeSummaryModal();
                }
            });

            loginButton.addEventListener('click', async () => {
                const email = emailInput.value;
                const password = passwordInput.value;
                loginError.classList.add('hidden');

                if (!email || !password) {
                    loginError.textContent = translations[currentLanguage].login_missing_credentials;
                    loginError.classList.remove('hidden');
                    return;
                }

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Login error:", error);
                    let errorMessage = translations[currentLanguage].login_generic_error;
                    switch (error.code) {
                        case 'auth/invalid-email': errorMessage = translations[currentLanguage].login_invalid_email; break;
                        case 'auth/user-disabled': errorMessage = translations[currentLanguage].login_user_disabled; break;
                        case 'auth/user-not-found':
                        case 'auth/wrong-password': errorMessage = translations[currentLanguage].login_invalid_credentials; break;
                        case 'auth/too-many-requests': errorMessage = translations[currentLanguage].login_too_many_requests; break;
                        default: errorMessage = `${translations[currentLanguage].error_prefix}: ${error.message}`; break;
                    }
                    loginError.textContent = errorMessage;
                    loginError.classList.remove('hidden');
                }
            });

            logoutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Logout error:", error);
                    alert(`${translations[currentLanguage].logout_error_prefix}: ${error.message}`);
                }
            });

            navHome.addEventListener('click', (event) => {
                event.preventDefault();
                showDashboardSection('home');
            });

            navDealFlow.addEventListener('click', (event) => {
                event.preventDefault();
                showDashboardSection('dealFlow');
            });

            pitchFilterRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (auth.currentUser) {
                        fetchAndRenderRanking(event.target.value);
                    }
                });
            });

            documentSelector.addEventListener('change', (event) => {
                if (auth.currentUser) {
                    updateMainDashboard(event.target.value);
                }
            });

            // Registration related event listeners
            showRegisterFormLink.addEventListener('click', (event) => {
                event.preventDefault();
                showAuthSection('register');
            });

            showLoginFormLink.addEventListener('click', (event) => {
                event.preventDefault();
                showAuthSection('login');
            });

            registerButton.addEventListener('click', async () => {
                const email = registerEmailInput.value;
                const password = registerPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                registerError.classList.add('hidden');

                if (!email || !password || !confirmPassword) {
                    registerError.textContent = translations[currentLanguage].register_missing_fields;
                    registerError.classList.remove('hidden');
                    return;
                }

                if (password.length < 6) {
                    registerError.textContent = translations[currentLanguage].register_password_too_short;
                    registerError.classList.remove('hidden');
                    return;
                }

                if (password !== confirmPassword) {
                    registerError.textContent = translations[currentLanguage].register_passwords_not_match;
                    registerError.classList.remove('hidden');
                    return;
                }

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    console.log("User registered and logged in:", user.email);

                    await setDoc(doc(db, "artifacts", APP_ID, "users", user.uid, "profile", "data"), {
                        email: user.email,
                        registeredAt: new Date(),
                    });
                    console.log(`User profile saved to Firestore for UID: ${user.uid}`);

                } catch (error) {
                    console.error("Registration error:", error);
                    let errorMessage = translations[currentLanguage].register_generic_error;
                    switch (error.code) {
                        case 'auth/email-already-in-use': errorMessage = translations[currentLanguage].register_email_in_use; break;
                        case 'auth/invalid-email': errorMessage = translations[currentLanguage].register_invalid_email; break;
                        case 'auth/weak-password': errorMessage = translations[currentLanguage].register_weak_password; break;
                        default: errorMessage = `${translations[currentLanguage].error_prefix}: ${error.message}`; break;
                    }
                    registerError.textContent = errorMessage;
                    registerError.classList.remove('hidden');
                }
            });

            // Upload Pitch button functionality (opens modal)
            uploadPitchButton.addEventListener('click', () => {
                if (auth.currentUser) {
                    uploadModal.classList.remove('hidden');
                    fileInput.value = ''; // Reset file input
                    uploadStatusMessage.textContent = ''; // Clear status message
                } else {
                    alert(translations[currentLanguage].upload_must_be_logged_in);
                    showAuthSection('login');
                }
            });

            // Close upload modal button
            closeUploadModalBtn.addEventListener('click', () => {
                uploadModal.classList.add('hidden');
            });

            // Sostituisci il vecchio event listener 'uploadFileBtn' con questo
            uploadFileBtn.addEventListener('click', async () => {
                const pitchDeckFile = document.getElementById('pitchDeckInput').files[0];
                const businessPlanFile = document.getElementById('businessPlanInput').files[0];
                
                if (!pitchDeckFile) {
                    uploadStatusMessage.textContent = "Il Pitch Deck è obbligatorio.";
                    uploadStatusMessage.style.color = '#ef4444';
                    return;
                }
            
                const user = auth.currentUser;
                if (!user) {
                    uploadStatusMessage.textContent = "Devi essere loggato per caricare i file.";
                    uploadStatusMessage.style.color = '#ef4444';
                    return;
                }
            
                const defaultView = document.getElementById('uploadDefaultView');
                const processingView = document.getElementById('uploadProcessingView');
                uploadFileBtn.disabled = true;
                uploadStatusMessage.textContent = "Caricamento file in corso...";
                uploadStatusMessage.style.color = '#475569';
            
                try {
                    const timestamp = Date.now();
                    const pitchDeckPath = `validatr-pitch-decks-input-folder/user_uploads/${user.uid}/${timestamp}_${pitchDeckFile.name}`;
                    let businessPlanPath = null;
            
                    const uploadPromises = [];
            
                    // Prepara il caricamento del Pitch Deck
                    const pitchDeckRef = ref(storage, pitchDeckPath);
                    uploadPromises.push(uploadBytes(pitchDeckRef, pitchDeckFile));
            
                    // Prepara il caricamento del Business Plan, se presente
                    if (businessPlanFile) {
                        businessPlanPath = `validatr-pitch-decks-input-folder/user_uploads/${user.uid}/${timestamp}_${businessPlanFile.name}`;
                        const businessPlanRef = ref(storage, businessPlanPath);
                        uploadPromises.push(uploadBytes(businessPlanRef, businessPlanFile));
                    }
            
                    // Aspetta che tutti i caricamenti siano completati
                    await Promise.all(uploadPromises);
                    console.log("Tutti i file sono stati caricati con successo.");
                    uploadStatusMessage.textContent = "File caricati. Avvio dell'analisi...";
            
                    // Ora chiama la nuova Cloud Function HTTP per iniziare l'analisi
                    const token = await user.getIdToken();
                    
                    const apiUrl = `https://process-pitch-deck-hjttc4pjcq-ew.a.run.app`; 
            
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            pitchDeckPath: pitchDeckPath,
                            businessPlanPath: businessPlanPath, // Sarà null se non caricato
                            originalFileName: pitchDeckFile.name // Usiamo il nome del pitch come nome del documento
                        })
                    });
            
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Errore durante l_avvio dell_analisi.');
                    }
                    
                    console.log("Analisi avviata con successo dal backend.");
                    
                    // Mostra la vista di elaborazione e imposta il timer
                    defaultView.classList.add('hidden');
                    processingView.classList.remove('hidden');
            
                    setTimeout(() => {
                        uploadModal.classList.add('hidden');
                        fetchDataInBothDashboards(user); // Ricarica i dati
                        // Reset del modale
                        setTimeout(() => {
                            defaultView.classList.remove('hidden');
                            processingView.classList.add('hidden');
                            document.getElementById('pitchDeckInput').value = '';
                            document.getElementById('businessPlanInput').value = '';
                            uploadStatusMessage.textContent = '';
                            uploadFileBtn.disabled = false;
                        }, 500);
                    }, 15000);
            
                } catch (error) {
                    console.error("Errore nel processo di upload e analisi:", error);
                    uploadStatusMessage.textContent = `Errore: ${error.message}`;
                    uploadStatusMessage.style.color = '#ef4444';
                    uploadFileBtn.disabled = false;
                }
            });
        });
    </script>
</body>

</html>