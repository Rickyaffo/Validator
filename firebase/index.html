<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VALIDATR™ - Dashboard Completa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Material Icons (Outlined style) for icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Font Changed to Roboto -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK (Versioni da CDN) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserSessionPersistence, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, query, getDocs, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref, uploadBytes } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // Configurazione Firebase del tuo progetto (Sostituisci con i tuoi valori reali)
        const firebaseConfig = {
            apiKey: "AIzaSyDlGp9jxE1YubvFm6MDqSMT9M9G_5iu1f4",
            authDomain: "validatr-mvp.firebaseapp.com",
            projectId: "validatr-mvp",
            storageBucket: "validatr-mvp.firebasestorage.app", 
            messagingSenderId: "967024558151",
            appId: "1:967024558151:web:55146fdedd24314cc6f162",
            measurementId: "G-JEE15JVL0N"
        };

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Espongo le istanze globalmente per lo script principale
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseStorage = storage;
        window.setPersistence = setPersistence;
        window.browserSessionPersistence = browserSessionPersistence;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.collection = collection;
        window.query = query;
        window.getDocs = getDocs;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.ref = ref;
        window.uploadBytes = uploadBytes;
        
        window.APP_ID = firebaseConfig.projectId;
        window.PITCH_INPUT_BUCKET = "validatr-pitch-decks-input"; // Sostituisci con il nome esatto del tuo bucket di input
    </script>

    <!-- Stilizzazione generale -->
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            /* Rimosso display: flex, flex-direction, align-items per lasciare il layout al contenitore principale */
            min-height: 100vh;
            padding-bottom: 2rem;
            /* margin-top: 80px; Rimosso, si userà padding-top su main */
        }
        .container-padding { padding-left: 1rem; padding-right: 1rem; }
        @media (min-width: 640px) { .container-padding { padding-left: 2rem; padding-right: 2rem; } }
        @media (min-width: 1024px) { .container-padding { padding-left: 4rem; padding-right: 4rem; } }
        .card {
            background-color: white; border-radius: 0.75rem; padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #e2e8f0; /* slate-200 */
        }
        .chart-container {
            position: relative; width: 100%; max-width: 900px; margin-left: auto; margin-right: auto;
            height: 500px; max-height: 700px;
        }
        @media (max-width: 768px) { .chart-container { height: 400px; } }
        .loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center;
            border-radius: 0.75rem; z-index: 10;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #0d9488; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Card Score Styling */
        .scorecard-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem;
            background-color: #f8fafc; border-radius: 0.5rem; border: 1px solid #e2e8f0;
            transition: background-color 0.3s ease-in-out, border-color 0.3s ease-in-out;
        }
        .scorecard-value { font-size: 2.25rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem; }
        .scorecard-label { font-size: 0.875rem; font-weight: 500; color: #475569; text-align: center; }
        .score-icon {
            font-size: 2.5rem; margin-bottom: 0.5rem; font-family: 'Material Icons Outlined'; font-weight: normal; font-style: normal;
            display: inline-block; line-height: 1; text-transform: none; letter-spacing: normal; word-wrap: normal; white-space: nowrap; direction: ltr;
            -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility; -moz-osx-font-smoothing: grayscale; font-feature-settings: 'liga';
        }
        /* Icon Colors (Aggiornate per i nuovi stati) */
        .score-class-investire { color: #10b981; } /* emerald-500 */
        .score-class-monitorare { color: #f59e0b; } /* amber-500 */
        .score-class-verificare { color: #f97316; } /* orange-600 */
        .score-class-pass { color: #ef4444; } /* red-500 */
        .score-class-default { color: #64748b; } /* slate-500 */

        /* Background Colors for Scorecards (Aggiornate per i nuovi stati) */
        .bg-class-investire { background-color: #d1fae5; border-color: #10b981; } /* emerald-100, emerald-500 */
        .bg-class-monitorare { background-color: #fef3c7; border-color: #f59e0b; } /* amber-100, amber-500 */
        .bg-class-verificare { background-color: #ffedd5; border-color: #f97316; } /* orange-100, orange-600 */
        .bg-class-pass { background-color: #fee2e2; border-color: #ef4444; } /* red-100, red-500 */
        .bg-class-default-scorecard { background-color: #f8fafc; border-color: #e2e8f0; } /* slate-50, slate-200 */

        /* Stile Cerchio Profilo */
        .profile-circle {
            width: 40px; height: 40px; border-radius: 50%; background-color: #10b981;
            color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;
            font-size: 1.25rem; cursor: pointer; border: 2px solid #0d9488;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .profile-circle-icon { font-size: 1.75rem; }

        /* Stilizzazione specifica per il Doughnut Chart */
        .doughnut-chart-container {
            position: relative;
            width: 100%;
            max-width: 350px; /* Larghezza adeguata per un doughnut chart */
            height: 350px; /* Altezza adeguata */
            margin: 2rem auto; /* Centra il grafico */
        }
    </style>
</head>
<body>
    <!-- Intestazione Principale e Barra di Navigazione -->
    <header class="w-full bg-white shadow-lg border-b border-slate-200 fixed top-0 z-20">
        <div class="container-padding mx-auto py-4 flex flex-row items-center justify-between">
            <div class="flex items-center mb-4 sm:mb-0">
                <!-- Logo di VALIDATR™ -->
                <img src="https://placehold.co/100x30/111827/F9FAFB?text=VALIDATR%E2%84%A2" alt="VALIDATR Logo" class="h-8 mr-3 rounded-md">
                <h1 class="text-3xl font-bold text-slate-900">VALIDATR™</h1>
            </div>
            <nav class="flex space-x-6 mb-4 sm:mb-0">
                <a href="#" id="navHome" class="text-slate-700 font-medium hover:text-teal-600 focus:outline-none focus:text-teal-600">Home (Dashboard Dettagliata)</a>
                <a href="#" id="navDealFlow" class="text-slate-700 font-medium hover:text-teal-600 focus:outline-none focus:text-teal-600">Deal Flow (Ranking Investitori)</a>
            </nav>
            <div id="authStatus" class="flex items-center text-slate-700 font-medium hidden">
                <button id="uploadPitchButton" class="mr-4 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50 transition duration-200 flex items-center">
                    <span class="material-icons-outlined text-xl mr-2">cloud_upload</span>
                    Carica Pitch
                </button>
                <div id="profileCircle" class="profile-circle mr-3">
                    <span class="material-icons-outlined profile-circle-icon">person</span>
                </div>
                Benvenuto, <span id="userEmail" class="ml-1 font-semibold text-teal-600"></span>!
                <button id="logoutButton" class="ml-4 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition duration-200">
                    Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Sezione di Login -->
    <div id="loginSection" class="w-full max-w-md card mt-[100px] p-8 flex flex-col items-center">
        <h2 class="text-2xl font-semibold text-slate-800 mb-6">Accedi a VALIDATR™</h2>
        <input type="email" id="emailInput" placeholder="Email" class="w-full px-4 py-2 mb-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
        <input type="password" id="passwordInput" placeholder="Password" class="w-full px-4 py-2 mb-6 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
        <button id="loginButton" class="w-full px-6 py-3 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50 transition duration-200">
            Accedi
        </button>
        <p id="loginError" class="text-red-600 mt-4 hidden"></p>
        <p class="mt-4 text-slate-600">Non hai un account? 
            <a href="#" id="showRegisterForm" class="text-teal-600 hover:text-teal-700 font-semibold">Registrati qui</a>
        </p>
    </div>

    <!-- Sezione di Registrazione (inizialmente nascosta) -->
    <div id="registerSection" class="w-full max-w-md card mt-[100px] p-8 flex flex-col items-center hidden">
        <h2 class="text-2xl font-semibold text-slate-800 mb-6">Registrati a VALIDATR™</h2>
        <input type="email" id="registerEmail" placeholder="Email" class="w-full px-4 py-2 mb-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
        <input type="password" id="registerPassword" placeholder="Password" class="w-full px-4 py-2 mb-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
        <input type="password" id="confirmPassword" placeholder="Conferma Password" class="w-full px-4 py-2 mb-6 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
        <button id="registerButton" class="w-full px-6 py-3 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50 transition duration-200">
            Registrati
        </button>
        <p id="registerError" class="text-red-600 mt-4 hidden"></p>
        <p class="mt-4 text-slate-600">Hai già un account? 
            <a href="#" id="showLoginForm" class="text-teal-600 hover:text-teal-700 font-semibold">Accedi qui</a>
        </p>
    </div>

    <!-- Contenuto Principale della Dashboard (Nascosto inizialmente, con padding per la navbar fissa) -->
    <main id="dashboardContent" class="w-full container-padding pt-[100px] hidden"> 
        <div class="mx-auto max-w-7xl w-full"> <!-- Outer wrapper for main content grid -->
            <div id="loadingOverlay" class="loading-overlay hidden"> 
                <div class="spinner"></div>
                <p class="ml-4 text-slate-700 text-lg">Caricamento dati...</p>
            </div>

            <!-- Home: Dashboard Dettagliata (Variabili Pitch Deck) -->
            <div id="homeDashboard" class="flex flex-col w-full">
                <header class="w-full container-padding mb-8 pt-8">
                    <div class="flex flex-col sm:flex-row items-center justify-between bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <h2 class="text-2xl font-bold text-slate-900 mb-4 sm:mb-0">
                            Dashboard Analisi Dettagliata
                        </h2>
                        <div class="flex items-center space-x-4">
                            <label for="documentSelector" class="text-slate-700 font-medium">Seleziona Pitch Deck:</label>
                            <select id="documentSelector" class="px-4 py-2 rounded-lg border border-slate-300 bg-slate-50 text-slate-800 shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                                <!-- Opzioni popolate da JS -->
                            </select>
                        </div>
                    </div>
                </header>

                <!-- Container for Scorecards, Variables Charts/Tables, and Coherence Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full"> 
                    <!-- Sezione: Riepilogo Generale (Scorecard) - Sarà col-span-2 quando in una griglia a 2 colonne -->
                    <section class="card lg:col-span-2 mb-8">
                        <h3 class="text-xl font-semibold text-slate-800 mb-6">Riepilogo Generale del Pitch Deck</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="scorecard-item">
                                <!-- Material Icon: analytics for chart-line -->
                                <span id="finalAdjustedScoreIcon" class="score-icon score-class-default">analytics</span>
                                <div id="finalAdjustedScoreValue" class="scorecard-value">--</div>
                                <div class="scorecard-label">Score Finale Regolato</div>
                            </div>
                            <div class="scorecard-item">
                                <!-- Material Icon: alt_route for project-diagram -->
                                <span id="coherenceIndexIcon" class="score-icon score-class-default">alt_route</span>
                                <div id="coherenceIndexValue" class="scorecard-value">--</div>
                                <div class="scorecard-label">Indice di Coerenza</div>
                            </div>
                            <div id="pitchClassCard" class="scorecard-item">
                                <!-- Material Icon: emoji_events for trophy -->
                                <span id="pitchClassIcon" class="score-icon score-class-default">emoji_events</span>
                                <div id="pitchClassValue" class="scorecard-value">--</div>
                                <div class="scorecard-label">Classe Pitch</div>
                            </div>
                        </div>
                        <div id="noCoreMetricsData" class="hidden text-center text-slate-500 mt-4">Nessun dato di riepilogo disponibile per questo pitch.</div>
                    </section>

                    <!-- Sezione Grafico a Barre delle Variabili -->
                    <section class="card flex flex-col w-full"> <!-- Questo sarà una colonna nella griglia a 2 colonne -->
                        <h3 class="text-xl font-semibold text-slate-800 mb-4">Punteggi Variabili Valutate</h3>
                        <p class="text-slate-600 mb-6">
                            Questo grafico a barre mostra i punteggi (0-100) assegnati a ciascuna delle 7 variabili chiave del pitch deck selezionato. Passa il mouse sulle barre per leggere la motivazione.
                        </p>
                        <div class="flex-grow flex items-center justify-center min-h-[300px]">
                            <div class="chart-container">
                                <canvas id="variablesChart"></canvas>
                            </div>
                        </div>
                        <div id="noDataChart" class="hidden text-center text-slate-500 mt-4">Nessun dato disponibile per il grafico.</div>
                    </section>

                    <!-- Sezione Tabella Dettagliata Variabili -->
                    <section class="card flex flex-col w-full"> <!-- Questo sarà l'altra colonna nella griglia a 2 colonne -->
                        <h3 class="text-xl font-semibold text-slate-800 mb-4">Dettaglio Variabili e Motivazioni</h3>
                        <p class="text-slate-600 mb-6">
                            Questa tabella fornisce i punteggi numerici e le motivazioni dettagliate per ogni variabile.
                        </p>
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-[500px] bg-white rounded-lg overflow-hidden">
                                <thead>
                                    <tr>
                                        <th class="py-3 px-4 rounded-tl-lg">Variabile</th>
                                        <th class="py-3 px-4">Punteggio</th>
                                        <th class="py-3 px-4 rounded-tr-lg">Motivazione</th>
                                    </tr>
                                </thead>
                                <tbody id="variablesTableBody">
                                    <!-- Righe popolate da JS -->
                                </tbody>
                            </table>
                        </div>
                        <div id="noDataTable" class="hidden text-center text-slate-500 mt-4">Nessun dato disponibile per la tabella.</div>
                    </section>

                    <!-- Nuova Sezione Dettaglio Coerenza con Dropdown e Doughnut Chart -->
                    <section class="card lg:col-span-2 mt-8 w-full"> <!-- Questo coprirà entrambe le colonne -->
                        <h3 class="text-xl font-semibold text-slate-800 mb-4">Analisi Coerenza tra Variabili</h3>
                        <p class="text-slate-600 mb-6">
                            Questa sezione mostra la distribuzione di coerenza tra le variabili e i dettagli per ogni coppia.
                        </p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-center w-full">
                            <div class="doughnut-chart-container">
                                <canvas id="coherenceDoughnutChart"></canvas>
                            </div>
                            <div>
                                <div class="flex flex-col sm:flex-row items-center sm:space-x-4 mb-4">
                                    <label for="coherencePairSelector" class="text-slate-700 font-medium mb-2 sm:mb-0">Seleziona Coppia:</label>
                                    <select id="coherencePairSelector" class="px-4 py-2 rounded-lg border border-slate-300 bg-slate-50 text-slate-800 shadow-sm focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent w-full sm:w-auto">
                                        <!-- Opzioni popolate da JS -->
                                    </select>
                                </div>
                                <div id="coherenceDetails" class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                                    <p class="text-slate-700 font-medium mb-2">Punteggio: <span id="selectedCoherenceScore" class="font-bold">--</span></p>
                                    <p class="text-slate-700">Motivazione: <span id="selectedCoherenceMotivation">Nessuna motivazione disponibile.</span></p>
                                </div>
                            </div>
                        </div>
                        <div id="noCoherenceData" class="hidden text-center text-slate-500 mt-4">Nessun dato di coerenza disponibile per questo pitch.</div>
                    </section>
                </div>
            </div>

            <!-- Deal Flow: Ranking Investitori -->
            <div id="dealFlowDashboard" class="flex flex-col w-full hidden">
                <header class="w-full container-padding mb-8 pt-8">
                    <div class="flex flex-col sm:flex-row items-center justify-between bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                        <h2 class="text-2xl font-bold text-slate-900 mb-4 sm:mb-0">
                            Deal Flow: Ranking Pitch per Investitori
                        </h2>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="pitchFilter" value="my" checked class="form-radio text-teal-600 h-5 w-5">
                                <span class="ml-2 text-slate-700 font-medium">I Miei Pitch</span>
                            </label>
                        </div>
                    </div>
                </header>
                
                <section class="card w-full">
                    <h3 class="text-xl font-semibold text-slate-800 mb-4">Classifica dei Pitch Deck (Score Finale Regolato)</h3>
                    <p class="text-slate-600 mb-6">
                        Questo grafico mostra tutti i pitch deck analizzati, ordinati in base al loro "Score Finale Regolato" in ordine decrescente. I pitch con i punteggi più alti sono in cima, rappresentando le opportunità più promettenti.
                    </p>
                    <div class="flex-grow flex items-center justify-center min-h-[300px]">
                        <div class="chart-container">
                            <canvas id="rankingChart"></canvas>
                        </div>
                    </div>
                    <div id="noRankingData" class="hidden text-center text-slate-500 mt-4">Nessun dato di ranking disponibile.</div>
                </section>
            </div>
        </div>
    </main>

    <!-- Upload Pitch Modal (Initially Hidden) -->
    <div id="uploadModal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-lg mx-4">
            <h2 class="text-2xl font-semibold text-slate-800 mb-6">Carica un Nuovo Pitch Deck</h2>
            <p class="text-slate-600 mb-4">Seleziona un file PDF da caricare per l'analisi.</p>
            <input type="file" id="fileInput" accept=".pdf" class="w-full px-4 py-2 mb-4 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500">
            <button id="uploadFileBtn" class="w-full px-6 py-3 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-opacity-50 transition duration-200 flex items-center justify-center">
                <span class="material-icons-outlined text-xl mr-2">cloud_upload</span>
                Carica Pitch
            </button>
            <p id="uploadStatusMessage" class="mt-4 text-center text-slate-700"></p>
            <button id="closeUploadModalBtn" class="mt-6 w-full px-6 py-3 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-opacity-50 transition duration-200">
                Chiudi
            </button>
        </div>
    </div>

    <!-- Script JavaScript -->
    <script type="module">
        // Elementi UI globali
        const loginSection = document.getElementById('loginSection');
        const registerSection = document.getElementById('registerSection'); 
        const dashboardContent = document.getElementById('dashboardContent');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginButton = document.getElementById('loginButton');
        const loginError = document.getElementById('loginError');
        const logoutButton = document.getElementById('logoutButton');
        const authStatus = document.getElementById('authStatus');
        const userEmailSpan = document.getElementById('userEmail');
        const navHome = document.getElementById('navHome');
        const navDealFlow = document.getElementById('navDealFlow');
        const profileCircle = document.getElementById('profileCircle'); 
        const uploadPitchButton = document.getElementById('uploadPitchButton'); 

        // Registration form elements
        const showRegisterFormLink = document.getElementById('showRegisterForm');
        const showLoginFormLink = document.getElementById('showLoginForm');
        const registerEmailInput = document.getElementById('registerEmail');
        const registerPasswordInput = document.getElementById('registerPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const registerButton = document.getElementById('registerButton');
        const registerError = document.getElementById('registerError');

        // NEW: Upload Modal elements
        const uploadModal = document.getElementById('uploadModal');
        const closeUploadModalBtn = document.getElementById('closeUploadModalBtn');
        const fileInput = document.getElementById('fileInput');
        const uploadFileBtn = document.getElementById('uploadFileBtn');
        const uploadStatusMessage = document.getElementById('uploadStatusMessage');

        // Sezioni della dashboard
        const homeDashboard = document.getElementById('homeDashboard');
        const dealFlowDashboard = document.getElementById('dealFlowDashboard');

        // Elementi della dashboard Home
        const documentSelector = document.getElementById('documentSelector');
        const variablesTableBody = document.getElementById('variablesTableBody');
        const variablesChartCanvas = document.getElementById('variablesChart');
        const coherencePairSelector = document.getElementById('coherencePairSelector');
        const selectedCoherenceScore = document.getElementById('selectedCoherenceScore');
        const selectedCoherenceMotivation = document.getElementById('selectedCoherenceMotivation');
        const coherenceDoughnutChartCanvas = document.getElementById('coherenceDoughnutChart'); // NEW: Doughnut Chart Canvas

        const noDataChartDiv = document.getElementById('noDataChart');
        const noDataTableDiv = document.getElementById('noDataTable');
        const noCoreMetricsDataDiv = document.getElementById('noCoreMetricsData');
        const noCoherenceDataDiv = document.getElementById('noCoherenceData');
        const finalAdjustedScoreValue = document.getElementById('finalAdjustedScoreValue');
        const finalAdjustedScoreIcon = document.getElementById('finalAdjustedScoreIcon');
        const coherenceIndexValue = document.getElementById('coherenceIndexValue');
        const coherenceIndexIcon = document.getElementById('coherenceIndexIcon');
        const pitchClassValue = document.getElementById('pitchClassValue');
        const pitchClassIcon = document.getElementById('pitchClassIcon');
        const pitchClassCard = document.getElementById('pitchClassCard');

        // Elementi della dashboard Deal Flow
        const rankingChartCanvas = document.getElementById('rankingChart');
        const noRankingDataDiv = document.getElementById('noRankingData');
        const pitchFilterRadios = document.querySelectorAll('input[name="pitchFilter"]');

        // Overlay di caricamento globale
        const loadingOverlay = document.getElementById('loadingOverlay');

        let variablesChart = null; // Inizializza a null
        let rankingChart = null;   // Inizializza a null
        let coherenceDoughnutChart = null; // NEW: Doughnut Chart instance
        let loadedAllData = {}; 

        // Firebase Auth, Firestore, Storage (recuperati dalla window)
        const auth = window.firebaseAuth;
        const setPersistence = window.setPersistence;
        const browserSessionPersistence = window.browserSessionPersistence;
        const signInWithEmailAndPassword = window.signInWithEmailAndPassword;
        const signOut = window.signOut;
        const onAuthStateChanged = window.onAuthStateChanged;
        const createUserWithEmailAndPassword = window.createUserWithEmailAndPassword; 
        const db = window.firebaseDb; 
        const setDoc = window.setDoc; 
        const APP_ID = window.APP_ID; 
        const docRef = window.doc; 
        const storage = window.firebaseStorage; 

        // NEW: Firebase Storage references
        const storageRef = window.ref;
        const uploadBytes = window.uploadBytes;
        const PITCH_INPUT_BUCKET = window.PITCH_INPUT_BUCKET; 

        // Funzione per mostrare una sezione e nascondere le altre (login/register)
        function showAuthSection(sectionId) {
            loginSection.classList.add('hidden');
            registerSection.classList.add('hidden');
            if (sectionId === 'login') {
                loginSection.classList.remove('hidden');
            } else if (sectionId === 'register') {
                registerSection.classList.remove('hidden');
            }
        }

        // Funzione per mostrare una sezione della dashboard e nascondere le altre
        function showDashboardSection(sectionId) {
            homeDashboard.classList.add('hidden');
            dealFlowDashboard.classList.add('hidden');
            if (sectionId === 'home') {
                homeDashboard.classList.remove('hidden');
                if (auth.currentUser) {
                    fetchDataInBothDashboards(auth.currentUser); 
                }
            } else if (sectionId === 'dealFlow') {
                dealFlowDashboard.classList.remove('hidden');
                if (auth.currentUser) {
                    fetchAndRenderRanking('my'); 
                }
            }
        }

        // Funzione per avvolgere le etichette lunghe nel grafico
        function wrapLabel(label, maxCharPerLine) {
            if (typeof label !== 'string') return label; 
            if (label.length <= maxCharPerLine) return label;
            let wrappedLabel = [];
            let words = label.split(' ');
            let currentLine = '';
            words.forEach((word, index) => {
                if ((currentLine + word).length <= maxCharPerLine) {
                    currentLine += (currentLine === '' ? '' : ' ') + word;
                } else {
                    wrappedLabel.push(currentLine);
                    currentLine = word;
                }
                if (index === words.length - 1) {
                    wrappedLabel.push(currentLine);
                }
            });
            return wrappedLabel;
        }
        
        // Funzione per pulire la dashboard principale
        function clearMainDashboard() {
            finalAdjustedScoreValue.textContent = '--';
            coherenceIndexValue.textContent = '--';
            pitchClassValue.textContent = '--';
            finalAdjustedScoreIcon.className = 'score-icon score-class-default';
            coherenceIndexIcon.className = 'score-icon score-class-default';
            pitchClassIcon.className = 'score-icon score-class-default';
            finalAdjustedScoreIcon.textContent = 'analytics';
            coherenceIndexIcon.textContent = 'alt_route';
            pitchClassIcon.textContent = 'emoji_events';


            pitchClassCard.classList.remove('bg-class-investire', 'bg-class-monitorare', 'bg-class-verificare', 'bg-class-pass');
            pitchClassCard.classList.add('bg-class-default-scorecard');
            
            variablesChartCanvas.style.display = 'none';
            variablesTableBody.innerHTML = '';
            
            // Clear coherence dropdown and details
            coherencePairSelector.innerHTML = '<option value="">Seleziona una coppia</option>';
            coherencePairSelector.disabled = true;
            selectedCoherenceScore.textContent = '--';
            selectedCoherenceMotivation.textContent = 'Nessuna motivazione disponibile.';

            noDataChartDiv.classList.remove('hidden');
            noDataTableDiv.classList.remove('hidden');
            noCoreMetricsDataDiv.classList.remove('hidden');
            noCoherenceDataDiv.classList.remove('hidden');

            if (variablesChart) { variablesChart.destroy(); variablesChart = null; }
            if (coherenceDoughnutChart) { coherenceDoughnutChart.destroy(); coherenceDoughnutChart = null; } // NEW: Destroy doughnut chart
        }

        // Funzione per aggiornare la dashboard principale (variabili dettagliate)
        function updateMainDashboard(selectedDocumentId) {
            const documentData = loadedAllData[selectedDocumentId];

            if (!documentData) {
                clearMainDashboard();
                return;
            }

            // Aggiungi log per ispezionare documentData
            console.log("DEBUG: Dati per il documento selezionato in updateMainDashboard:", documentData);
            console.log("DEBUG: core_metrics:", documentData.core_metrics);
            console.log("DEBUG: variables:", documentData.variables);
            console.log("DEBUG: coherence_pairs:", documentData.coherence_pairs);


            // Aggiorna le scorecard di riepilogo (usa core_metrics)
            if (documentData.core_metrics) {
                const coreMetrics = documentData.core_metrics;
                finalAdjustedScoreValue.textContent = coreMetrics.final_adjusted_score ? coreMetrics.final_adjusted_score.toFixed(2) : '--';
                coherenceIndexValue.textContent = coreMetrics.indice_coerenza ? coreMetrics.indice_coerenza.toFixed(2) : '--';
                pitchClassValue.textContent = coreMetrics.classe_pitch || '--'; // Usa 'classe_pitch' da Firestore

                // Reset scorecard background classes
                const scorecardClasses = ['bg-class-investire', 'bg-class-monitorare', 'bg-class-verificare', 'bg-class-pass', 'bg-class-default-scorecard'];
                pitchClassCard.classList.remove(...scorecardClasses);

                // Update icon colors and card background based on class
                finalAdjustedScoreIcon.className = 'score-icon';
                coherenceIndexIcon.className = 'score-icon';
                pitchClassIcon.className = 'score-icon';
                finalAdjustedScoreIcon.textContent = 'analytics';
                coherenceIndexIcon.textContent = 'alt_route';
                pitchClassIcon.textContent = 'emoji_events';


                const currentClass = coreMetrics.classe_pitch;
                if (currentClass === 'INVESTIRE') {
                    finalAdjustedScoreIcon.classList.add('score-class-investire');
                    coherenceIndexIcon.classList.add('score-class-investire');
                    pitchClassIcon.classList.add('score-class-investire');
                    pitchClassCard.classList.add('bg-class-investire');
                } else if (currentClass === 'MONITORARE') {
                    finalAdjustedScoreIcon.classList.add('score-class-monitorare');
                    coherenceIndexIcon.classList.add('score-class-monitorare');
                    pitchClassIcon.classList.add('score-class-monitorare');
                    pitchClassCard.classList.add('bg-class-monitorare');
                } else if (currentClass === 'VERIFICARE') {
                    finalAdjustedScoreIcon.classList.add('score-class-verificare');
                    coherenceIndexIcon.classList.add('score-class-verificare');
                    pitchClassIcon.classList.add('score-class-verificare');
                    pitchClassCard.classList.add('bg-class-verificare');
                } else if (currentClass === 'PASS') {
                    finalAdjustedScoreIcon.classList.add('score-class-pass');
                    coherenceIndexIcon.classList.add('score-class-pass');
                    pitchClassIcon.classList.add('score-class-pass');
                    pitchClassCard.classList.add('bg-class-pass');
                } else { // Default or non-classified
                    finalAdjustedScoreIcon.classList.add('score-class-default');
                    coherenceIndexIcon.classList.add('score-class-default');
                    pitchClassIcon.classList.add('score-class-default');
                    pitchClassCard.classList.add('bg-class-default-scorecard');
                }
                noCoreMetricsDataDiv.classList.add('hidden');
            } else {
                noCoreMetricsDataDiv.classList.remove('hidden');
            }

            // Update Variables Chart and Table (usa variables)
            if (documentData.variables && documentData.variables.length > 0) {
                variablesChartCanvas.style.display = 'block';
                noDataChartDiv.classList.add('hidden');
                noDataTableDiv.classList.add('hidden');

                const labels = documentData.variables.map(v => wrapLabel(v.nome_variabile, 16));
                const scores = documentData.variables.map(v => v.punteggio_variabile);
                const motivations = documentData.variables.map(v => v.motivazione_variabile);

                if (variablesChart) {
                    variablesChart.destroy(); // Distruggi il vecchio grafico
                }

                const ctx = variablesChartCanvas.getContext('2d');
                variablesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Punteggio',
                            data: scores,
                            backgroundColor: scores.map(score => {
                                if (score >= 77) return '#10b981'; // INVESTIRE (emerald-500)
                                if (score >= 55) return '#f59e0b'; // MONITORARE (amber-500)
                                if (score >= 40) return '#f97316'; // VERIFICARE (orange-600)
                                return '#ef4444'; // PASS (red-500)
                            }),
                            borderColor: scores.map(score => {
                                if (score >= 77) return '#059669'; // emerald-700
                                if (score >= 55) return '#d97706'; // amber-600
                                if (score >= 40) return '#ea580c'; // orange-700
                                return '#dc2626'; // red-600
                            }),
                            borderWidth: 1,
                            motivations: motivations
                        }]
                    },
                    options: {
                        indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    title: (context) => Array.isArray(context[0].label) ? context[0].label.join(' ') : context[0].label,
                                    label: (context) => `Punteggio: ${context.parsed.x}`,
                                    afterLabel: (context) => `Motivazione: ${context.dataset.motivations[context.dataIndex]}`
                                }
                            }
                        },
                        scales: {
                            x: { beginAtZero: true, max: 100, title: { display: true, text: 'Punteggio (0-100)', color: '#475569' }, ticks: { color: '#475569' }, grid: { color: '#e2e8f0' } },
                            y: { title: { display: true, text: 'Variabile', color: '#475569' }, ticks: { color: '#475569' }, grid: { color: '#e2e8f0' } }
                        }
                    }
                });
            } else {
                variablesChartCanvas.style.display = 'none';
                variablesTableBody.innerHTML = '';
                noDataChartDiv.classList.remove('hidden');
                noDataTableDiv.classList.remove('hidden');
                if (variablesChart) variablesChart.destroy(); // Assicurati che sia distrutto anche qui
            }

            // Update Coherence Details with Dropdown (usa coherence_pairs)
            if (documentData.coherence_pairs && documentData.coherence_pairs.length > 0) {
                coherencePairSelector.innerHTML = '<option value="">Seleziona una coppia</option>'; 
                documentData.coherence_pairs.forEach((cp, index) => {
                    const option = document.createElement('option');
                    option.value = index; 
                    option.textContent = cp.nome_coppia;
                    coherencePairSelector.appendChild(option);
                });
                coherencePairSelector.disabled = false;
                noCoherenceDataDiv.classList.add('hidden');

                if (documentData.coherence_pairs.length > 0) {
                    coherencePairSelector.value = 0; 
                    const firstPair = documentData.coherence_pairs[0];
                    selectedCoherenceScore.textContent = firstPair.punteggio_coppia; 
                    selectedCoherenceMotivation.textContent = firstPair.motivazione_coppia; 
                }

                coherencePairSelector.onchange = (event) => {
                    const selectedIndex = event.target.value;
                    if (selectedIndex !== "") {
                        const selectedPair = documentData.coherence_pairs[selectedIndex];
                        selectedCoherenceScore.textContent = selectedPair.punteggio_coppia;
                        selectedCoherenceMotivation.textContent = selectedPair.motivazione_coppia;
                    } else {
                        selectedCoherenceScore.textContent = '--';
                        selectedCoherenceMotivation.textContent = 'Nessuna motivazione disponibile.';
                    }
                };
                
                // NEW: Update Coherence Doughnut Chart
                createOrUpdateCoherenceDoughnutChart(
                    'coherenceDoughnutChart', 
                    documentData.core_metrics?.coerenza_superiore_50 || 0,
                    documentData.core_metrics?.coerenza_inferiore_50 || 0
                );

            } else {
                coherencePairSelector.innerHTML = '<option value="">Nessun dato di coerenza disponibile</option>';
                coherencePairSelector.disabled = true;
                selectedCoherenceScore.textContent = '--';
                selectedCoherenceMotivation.textContent = 'Nessuna motivazione disponibile.';
                noCoherenceDataDiv.classList.remove('hidden');
                if (coherenceDoughnutChart) { coherenceDoughnutChart.destroy(); coherenceDoughnutChart = null; } // NEW: Destroy doughnut chart
            }
        }

        // Funzione per creare/aggiornare il Doughnut Chart della Coerenza
        function createOrUpdateCoherenceDoughnutChart(canvasId, highCoherenceCount, lowCoherenceCount) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            if (coherenceDoughnutChart) {
                coherenceDoughnutChart.destroy();
            }

            if (highCoherenceCount === 0 && lowCoherenceCount === 0) {
                coherenceDoughnutChart = null;
                return;
            }

            const total = highCoherenceCount + lowCoherenceCount;
            const highCoherencePercentage = total > 0 ? ((highCoherenceCount / total) * 100).toFixed(1) : 0;
            const lowCoherencePercentage = total > 0 ? ((lowCoherenceCount / total) * 100).toFixed(1) : 0;

            coherenceDoughnutChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [`Alta Coerenza (${highCoherencePercentage}%)`, `Bassa Coerenza (${lowCoherencePercentage}%)`],
                    datasets: [{
                        data: [highCoherenceCount, lowCoherenceCount],
                        backgroundColor: [
                            '#10b981', /* emerald-500 */
                            '#ef4444'  /* red-500 */
                        ],
                        borderColor: [
                            '#059669', /* emerald-600 */
                            '#dc2626'  /* red-600 */
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#475569', // slate-600
                                font: {
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }


        // Funzione per recuperare tutti i dati della dashboard (Home e Deal Flow) da Cloud Function API
        async function fetchDataInBothDashboards(user) {
            if (!user) {
                console.log("Utente non autenticato. Impossibile recuperare i dati.");
                loadingOverlay.classList.add('hidden');
                clearMainDashboard();
                return;
            }

            loadingOverlay.classList.remove('hidden'); // Mostra overlay di caricamento

            try {
                const token = await user.getIdToken();
                const apiUrl = `https://europe-west1-validatr-mvp.cloudfunctions.net/fetchPitchData`; 
                
                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                }); 
                
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        console.error("Accesso API negato. Potresti non avere i permessi o il token è scaduto.");
                        await signOut(auth); // Forza il logout
                        return;
                    }
                    throw new Error(`Errore HTTP! Stato: ${response.status}`);
                }
                const data = await response.json();


                loadedAllData = data; 

                // Popola il selettore documenti per la Home Dashboard
                documentSelector.innerHTML = '';
                if (Object.keys(loadedAllData).length === 0) {
                     const option = document.createElement('option');
                     option.value = '';
                     option.textContent = 'Nessun Pitch Deck disponibile';
                     documentSelector.appendChild(option);
                     documentSelector.disabled = true;
                     clearMainDashboard(); 
                } else {
                    documentSelector.disabled = false;
                    const sortedDocIds = Object.keys(loadedAllData).sort((a, b) => a.localeCompare(b));
                    sortedDocIds.forEach(docId => {
                        const option = document.createElement('option');
                        option.value = docId;
                        option.textContent = loadedAllData[docId].document_name || docId; 
                        documentSelector.appendChild(option);
                    });
                     if (sortedDocIds.length > 0) {
                        documentSelector.value = sortedDocIds[0];
                        updateMainDashboard(sortedDocIds[0]); 
                     }
                }

            } catch (error) {
                console.error("Errore durante il recupero dei dati da Cloud Function API:", error);
                clearMainDashboard();
            } finally {
                loadingOverlay.classList.add('hidden'); // Nasconde overlay di caricamento
            }
        }


        // Funzione per renderizzare la dashboard di ranking (usa i dati già caricati)
        async function fetchAndRenderRanking(filterType = 'my') { 
            const user = auth.currentUser;
            if (!user) {
                console.log("Utente non autenticato. Impossibile recuperare i dati per il ranking.");
                loadingOverlay.classList.add('hidden');
                noRankingDataDiv.classList.remove('hidden');
                noRankingDataDiv.textContent = 'Accedi per visualizzare la dashboard.';
                if (rankingChart) rankingChart.destroy();
                return;
            }

            if (Object.keys(loadedAllData).length === 0) {
                await fetchDataInBothDashboards(user); 
            }
            
            const rankingData = [];
            for (const docId in loadedAllData) {
                const doc = loadedAllData[docId];
                if (doc.core_metrics && doc.core_metrics.final_adjusted_score !== undefined) {
                    rankingData.push({
                        name: doc.document_name || docId, 
                        score: doc.core_metrics.final_adjusted_score
                    });
                }
            }

            rankingData.sort((a, b) => b.score - a.score);

            if (rankingData.length === 0) {
                rankingChartCanvas.style.display = 'none';
                noRankingDataDiv.classList.remove('hidden');
                noRankingDataDiv.textContent = `Nessun dato di ranking disponibile per i tuoi pitch.`; 
                if (rankingChart) rankingChart.destroy();
                return;
            } else {
                rankingChartCanvas.style.display = 'block';
                noRankingDataDiv.classList.add('hidden');
            }

            const labels = rankingData.map(item => item.name);
            const scores = rankingData.map(item => item.score);

            const backgroundColors = [];
            const borderColors = [];
            const numItems = rankingData.length;

            for (let i = 0; i < numItems; i++) {
                if (i === 0) { 
                    backgroundColors.push('#34D399'); 
                    borderColors.push('#059669'); 
                } else if (i === 1) { 
                    backgroundColors.push('#10B981'); 
                    borderColors.push('#047857'); 
                } else if (i === 2) { 
                    backgroundColors.push('#059669'); 
                    borderColors.push('#065F46'); 
                    } else if (i >= numItems - 3 && numItems > 3) { 
                    if (i === numItems - 1) { 
                        backgroundColors.push('#B91C1C'); 
                        borderColors.push('#7F1D1D'); 
                    } else if (i === numItems - 2) { 
                        backgroundColors.push('#EF4444'); 
                        borderColors.push('#DC2626'); 
                    } else { 
                        backgroundColors.push('#F87171'; 
                        borderColors.push('#EF4444'); 
                    }
                } else { 
                    backgroundColors.push('#FBBF24'; 
                    borderColors.push('#F59E0B'; 
                }
            }

            if (rankingChart) {
                rankingChart.data.labels = labels;
                rankingChart.data.datasets[0].data = scores;
                rankingChart.data.datasets[0].backgroundColor = backgroundColors;
                rankingChart.data.datasets[0].borderColor = borderColors;
                rankingChart.update();
            } else {
                const ctx = rankingChartCanvas.getContext('2d');
                rankingChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Score Finale Regolato',
                            data: scores,
                            backgroundColor: backgroundColors, 
                            borderColor: borderColors, 
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y', 
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false 
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.parsed.x.toFixed(2)}`;
                                    }
                                }
                            },
                        },
                        scales: {
                            x: {
                                beginAtZero: true,
                                max: 100, 
                                title: {
                                    display: true,
                                    text: 'Score Finale Regolato (0-100)',
                                    color: '#475569'
                                },
                                ticks: {
                                    color: '#475569'
                                },
                                grid: {
                                    color: '#e2e8f0'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Pitch Deck',
                                    color: '#475569'
                                    },
                                    ticks: {
                                    color: '#475569'
                                },
                                grid: {
                                    color: '#e2e8f0'
                                }
                            }
                        }
                    }
                });
            }
        }


        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Gestione Autenticazione Firebase
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("Utente loggato:", user.email);
                    userEmailSpan.textContent = user.email;
                    profileCircle.textContent = user.email ? user.email.charAt(0).toUpperCase() : 'U';
                    authStatus.classList.remove('hidden');
                    loginSection.classList.add('hidden');
                    dashboardContent.classList.remove('hidden');
                    loginError.classList.add('hidden');

                    // Al login, recupera tutti i dati dalla Cloud Function API
                    await fetchDataInBothDashboards(user);
                    
                    showDashboardSection('home'); 

                } else {
                    console.log("Utente disconnesso.");
                    authStatus.classList.add('hidden');
                    loginSection.classList.remove('hidden');
                    dashboardContent.classList.add('hidden');
                    // showAuthSection('login'); 
                    if (variablesChart) { variablesChart.destroy(); variablesChart = null; }
                    if (rankingChart) { rankingChart.destroy(); rankingChart = null; }
                    clearMainDashboard(); 
                    loadedAllData = {}; 
                }
            });

            loginButton.addEventListener('click', async () => {
                const email = emailInput.value;
                const password = passwordInput.value;
                loginError.classList.add('hidden');

                if (!email || !password) {
                    loginError.textContent = 'Inserisci email e password.';
                    loginError.classList.remove('hidden');
                    return;
                }

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error("Errore di accesso:", error);
                    let errorMessage = 'Errore di accesso. Riprova.';
                    switch (error.code) {
                        case 'auth/invalid-email': errorMessage = 'Email non valida.'; break;
                        case 'auth/user-disabled': errorMessage = 'Questo utente è stato disabilitato.'; break;
                        case 'auth/user-not-found':
                        case 'auth/wrong-password': errorMessage = 'Credenziali non valide.'; break;
                        case 'auth/too-many-requests': errorMessage = 'Troppi tentativi falliti. Riprova più tardi.'; break;
                        default: errorMessage = `Errore: ${error.message}`; break;
                    }
                    loginError.textContent = errorMessage;
                    loginError.classList.remove('hidden');
                }
            });

            logoutButton.addEventListener('click', async () => {
                try {
                    await signOut(auth);
                } catch (error) {
                    console.error("Errore durante il logout:", error);
                }
            });

            navHome.addEventListener('click', (event) => {
                event.preventDefault();
                showDashboardSection('home');
            });

            navDealFlow.addEventListener('click', (event) => {
                event.preventDefault();
                showDashboardSection('dealFlow');
            });

            pitchFilterRadios.forEach(radio => {
                radio.addEventListener('change', (event) => {
                    if (auth.currentUser) {
                        fetchAndRenderRanking('my');
                    }
                });
            });

            documentSelector.addEventListener('change', (event) => {
                if (auth.currentUser) {
                    updateMainDashboard(event.target.value);
                }
            });
        });
    </script>
</body>
</html>
